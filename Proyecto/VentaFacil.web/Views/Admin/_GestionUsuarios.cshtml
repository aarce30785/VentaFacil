@model VentaFacil.web.Models.Response.Admin.UsuarioListResponse

<style>
    .premium-table thead th {
        background-color: #f8fafc;
        color: #fff !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
    }
    .main-btn.primary-btn.btn-hover {
        border-radius: 30px !important;
        padding-left: 2rem;
        padding-right: 2rem;
    }
    .input-group-search {
        border-radius: 30px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(109,76,65,0.08);
        background: #f8fafc;
    }
    .input-group-search input {
        border: none;
        background: #f8fafc;
        border-radius: 30px 0 0 30px;
        padding-left: 1.2rem;
        font-size: 1rem;
    }
    .input-group-search .btn-search {
        background: #6d4c41;
        color: #fff;
        border-radius: 0 30px 30px 0;
        border: none;
        font-weight: 600;
        padding: 0 1.5rem;
        transition: background 0.2s;
    }
    .input-group-search .btn-search:hover {
        background: #54362d;
        color: #fff;
    }
    .btn-clear {
        border-radius: 30px !important;
        background: #f3f4f6 !important;
        color: #6d4c41 !important;
        border: none;
        font-weight: 600;
        padding: 0.5rem 1.5rem;
        margin-left: 0.5rem;
        transition: background 0.2s;
    }
    .btn-clear:hover {
        background: #e0e0e0 !important;
        color: #54362d !important;
    }
</style>

<!-- Controles de Búsqueda y Filtros -->
<div class="row mb-4">
    <div class="col-md-8">
        <form method="get" asp-action="IndexUsuarios" class="row g-3" id="filtrosForm">
            <!-- Campo de búsqueda -->
            <div class="col-md-5">
                <div class="input-group input-group-search">
                    <input type="text" name="busqueda" class="form-control" 
                           placeholder="Buscar por nombre o correo..." 
                           value="@Model.Busqueda" />
                    <button type="submit" class="btn btn-search">
                        <i class="lni lni-search-alt"></i> Buscar
                    </button>
                </div>
            </div>

            <!-- Filtro por rol -->
            <div class="col-md-4">
                <select name="rolFiltro" class="form-select">
                    <option value="">Todos los roles</option>
                    @foreach (var rol in ViewBag.Roles)
                    {
                        <option value="@rol.Value" 
                                selected="@(Model.RolFiltro?.ToString() == rol.Value ? "selected" : null)">
                            @rol.Text
                        </option>
                    }
                </select>
            </div>

            <!-- Botones de acción -->
            <div class="col-md-3 d-flex align-items-center">
                <a href="@Url.Action("LimpiarFiltros", "Admin")" class="btn btn-clear">
                    <i class="lni lni-close"></i> Limpiar
                </a>
            </div>

            <!-- Campos ocultos para mantener otros parámetros -->
            <input type="hidden" name="pagina" value="1" />
            <input type="hidden" name="cantidadPorPagina" value="10" />
        </form>
    </div>

    <div class="col-md-4 text-end">
        <a href="@Url.Action("CrearUsuario", "Admin")" class="main-btn primary-btn btn-hover">
            <i class="lni lni-plus"></i> Agregar Usuario
        </a>
    </div>
</div>

<!-- Mensaje cuando no hay resultados CON FILTROS APLICADOS -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No se encontraron usuarios</strong> que coincidan con los criterios de búsqueda.
        <a href="@Url.Action("LimpiarFiltros")" class="alert-link ms-2">Mostrar todos los usuarios</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Mensaje cuando no hay usuarios en absoluto -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && string.IsNullOrEmpty(Model.Busqueda) && !Model.RolFiltro.HasValue)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No hay usuarios registrados en el sistema.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabla de Usuarios -->
<div class="table-wrapper table-responsive">
    <table class="table premium-table">
        <thead>
            <tr>
                <th class="lead-name"><h6>Nombre</h6></th>
                <th class="lead-email"><h6>Email</h6></th>
                <th class="lead-role"><h6>Rol</h6></th>
                <th><h6>Acción</h6></th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Usuarios != null && Model.Usuarios.Any())
            {
                foreach (var usuario in Model.Usuarios)
                {
                    <tr>
                        <td class="min-width">
                            <div class="lead">
                                <div class="lead-image">
                                    <img src="assets/images/lead/lead-1.png" alt="" />
                                </div>
                                <div class="lead-text">
                                    <p>@usuario.Nombre</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            <div class="lead">
                                <div class="lead-image">
                                    <img src="assets/images/lead/lead-1.png" alt="" />
                                </div>
                                <div class="lead-text">
                                    <p>@usuario.Correo</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            <span class="status-btn active-btn">@usuario.Rol</span>
                        </td>
                        <td>
                            <div class="action d-flex gap-2">
                                <!-- Editar -->
                                <a href="@Url.Action("EditarUsuario", "Admin", new { id = usuario.Id_Usr })"
                                   class="text-warning" title="Editar">
                                    <i class="lni lni-pencil"></i>
                                </a>

                                <!-- Eliminar -->
                                <a class="text-danger" href="javascript:void(0);"
                                   onclick="confirmarEliminacion(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')"
                                   title="Eliminar">
                                    <i class="lni lni-trash-can"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
                }
            }
            else if (Model.Usuarios != null && !Model.Usuarios.Any())
            {
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="text-muted">
                            <i class="lni lni-users me-2"></i>
                            @if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                            {
                                <span>No se encontraron usuarios con los filtros aplicados</span>
                            }
                            else
                            {
                                <span>No hay usuarios registrados</span>
                            }
                        </div>
                    </td>
                </tr>
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="text-muted">
                            <i class="lni lni-warning me-2"></i>
                            Error al cargar los usuarios
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Menú de Paginación -->
@if (Model.TotalPaginas > 1 && Model.Usuarios != null && Model.Usuarios.Any())
{
    <div class="pagination-wrapper mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <!-- Botón Anterior -->
                <li class="page-item @(Model.PaginaActual == 1 ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual - 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })"
                       tabindex="-1" aria-disabled="@(Model.PaginaActual == 1 ? "true" : "false")">
                        <i class="lni lni-chevron-left"></i>
                    </a>
                </li>

                <!-- Números de página -->
                @for (int i = 1; i <= Model.TotalPaginas; i++)
                {
                    <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("IndexUsuarios", "Admin", new { 
                               pagina = i, 
                               cantidadPorPagina = 10,
                               busqueda = Model.Busqueda,
                               rolFiltro = Model.RolFiltro
                           })">@i</a>
                    </li>
                }

                <!-- Botón Siguiente -->
                <li class="page-item @(Model.PaginaActual == Model.TotalPaginas ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual + 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })">
                        <i class="lni lni-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Información de paginación -->
        <div class="pagination-info text-center mt-2">
            @{
                var inicio = (Model.PaginaActual - 1) * 10 + 1;
                var fin = Math.Min(Model.PaginaActual * 10, Model.TotalUsuarios);
            }
            
            <p class="text-sm text-muted">
                Mostrando @inicio-@fin de @Model.TotalUsuarios registros
                
                @if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                {
                    <span class="ms-2">
                        <a href="@Url.Action("LimpiarFiltros")" class="text-primary text-decoration-underline">
                            (Ver todos)
                        </a>
                    </span>
                }
            </p>
        </div>
    </div>
}

<script>
    // ========== FUNCIONALIDAD PARA USUARIOS ==========
    
    // Auto-submit del filtro de rol cuando cambia
    const rolFilter = document.getElementById('rolFiltroSelect'); // We will add this ID
    if (rolFilter) {
        rolFilter.addEventListener('change', function() {
            document.getElementById('filtrosForm').submit();
        });
    } else {
        document.querySelector('#filtrosForm select[name="rolFiltro"]')?.addEventListener('change', function() {
            document.getElementById('filtrosForm').submit();
        });
    }

    // Manejar el evento de enter en el campo de búsqueda
    const busquedaInput = document.querySelector('#filtrosForm input[name="busqueda"]');
    if (busquedaInput) {
        busquedaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('filtrosForm').submit();
            }
        });
        
         busquedaInput.addEventListener('input', function(e) {
            e.stopPropagation();
        });
    }

    // Función eliminar (Simplificada para usar fetch y recargar)
    function confirmarEliminacion(usuarioId, nombreUsuario) {
        if (confirm(`¿Está seguro que desea eliminar al usuario "${nombreUsuario}"?`)) {
            fetch(`@Url.Action("EliminarUsuario", "Admin")?id=${usuarioId}`, {
                method: 'GET', // Cambiado a GET para simplificar ya que el controller es GET (aunque debería ser POST idealmente, pero el controller actual es GET)
                headers: {
                    // 'RequestVerificationToken': ... (Si fuera POST)
                }
            })
            .then(response => {
                if (response.ok || response.redirected) {
                    // Si el controller redirige, seguir la redirección o recargar
                    window.location.reload();
                } else {
                    alert('Error al eliminar el usuario');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión');
            });
        }
    }
</script>
