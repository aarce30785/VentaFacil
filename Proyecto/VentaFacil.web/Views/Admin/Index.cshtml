@using VentaFacil.web.Models.Response.Admin
@using VentaFacil.web.Models.Dto
@using VentaFacil.web.Models.Response.Producto
@model UsuarioListResponse
@{
    ViewData["Title"] = "Panel de administrador";
    Layout = "_LayoutPlantilla";
    var productosResponse = ViewData["Productos"] as ListProductoResponse ?? new ListProductoResponse();
}



<div class="admin-wrapper">
    <div class="pt-30">
        <!-- Header -->
        <div class="hero-section d-flex justify-content-between align-items-center px-4" style="text-align: left; margin-top: -1.5rem;">
            <div class="position-relative z-1">
                <h1 class="hero-title fw-bold mb-2 text-white"><i class="lni lni-cog me-2"></i>Panel de Administrador</h1>
                <p class="mb-0 text-white-50 fs-5">Gestiona usuarios, productos y configuraciones generales.</p>
            </div>
            <div class="position-relative z-1 d-none d-md-block">
                <div class="breadcrumb-wrapper">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#0" class="text-white-50">Dashboard</a></li>
                            <li class="breadcrumb-item active text-white" aria-current="page">Gestión</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        
            <div class="row">
                <div class="col-lg-12">
                    
                        <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active btn-premium" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                                    <i class="lni lni-users me-2"></i>Usuarios
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-premium" id="products-tab" data-bs-toggle="pill" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Productos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-premium" id="categoria-tab" data-bs-toggle="pill" data-bs-target="#categoria" type="button" role="tab" aria-controls="categoria" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Categoria
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="adminTabsContent">
                            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                                <div class="table-container">
                                    <partial name="_GestionUsuarios" model="Model" />
                                </div>
                            </div>
                            <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                                <div class="table-container">
                                    <partial name="_GestionProductos" model="productosResponse" />
                                </div>
                            </div>
                            <div class="tab-pane fade" id="categoria" role="tabpanel" aria-labelledby="categoria-tab">
                                <div class="table-container text-center py-5">
                                    <i class="lni lni-package text-muted" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3 text-muted">Gestión de Categorías</h4>
                                    <p class="text-muted">Esta funcionalidad estará disponible próximamente.</p>
                                </div>
                            </div>
                        </div>
                    
                </div>
            </div>
        
    </div>
</div>

@section Scripts {
    <script>
        // Funciones auxiliares globales para mensajes y errores
        function limpiarErrores() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            const alert = document.querySelector('.alert-danger');
            if (alert) alert.remove();
        }

        function mostrarError(campoId, mensaje) {
            const input = document.getElementById(campoId);
            if (input) {
                input.classList.add('is-invalid');
                const errorSpan = document.querySelector(`span[data-valmsg-for="${campoId}"]`) || 
                                  document.querySelector(`span[data-valmsg-for="${campoId}"]`) ||
                                  input.nextElementSibling;
                if (errorSpan) errorSpan.textContent = mensaje;
            }
        }

        function mostrarErrorGeneral(mensaje) {
            // Usar SweetAlert2 para errores generales
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: mensaje,
                confirmButtonText: 'Entendido'
            });
        }

        function mostrarMensajeExito(mensaje) {
            // Usar Toastify para mensajes de éxito
            Toastify({
                text: mensaje,
                duration: 3000,
                close: true,
                gravity: "top", // `top` or `bottom`
                position: "right", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "linear-gradient(to right, #00b09b, #96c93d)",
                },
                onClick: function(){} // Callback after click
            }).showToast();
        }

        function mostrarErroresEnFormulario(errors, fieldErrors) {
            if (errors && errors.length > 0) {
                 // Si hay errores generales, mostrarlos con SweetAlert
                 mostrarErrorGeneral(errors.join('\n'));
            }

            if (fieldErrors) {
                for (const [key, value] of Object.entries(fieldErrors)) {
                    // Intentar encontrar el campo por ID o nombre
                    const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        // Buscar el span de validación
                        let errorSpan = document.querySelector(`span[data-valmsg-for="${key}"]`);
                        if (!errorSpan) {
                          // Si no existe, buscar el siguiente elemento con clase text-danger
                          errorSpan = input.parentNode.querySelector('.text-danger');
                        }
                        
                        if (errorSpan) {
                            errorSpan.textContent = Array.isArray(value) ? value[0] : value;
                        }
                    }
                }
            }
        }

        // ==========================================
        // SOLUCIÓN GLOBAL PARA MODALES (Solución 2)
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Delegación de eventos para manejar cualquier modal dinámico
            document.body.addEventListener('keydown', function(e) {
                // Si el evento ocurre dentro de un modal
                if (e.target.closest('.modal')) {
                    // Si se presiona Enter en un input (no textarea, no submit)
                    if (e.key === 'Enter' && e.target.tagName === 'INPUT' && 
                        e.target.type !== 'submit' && e.target.type !== 'button') {
                        e.preventDefault();
                        console.log('Enter prevenido en modal globalmente');
                        return false;
                    }
                }
            });

            // Prevenir submit estándar en formularios de modales
            document.body.addEventListener('submit', function(e) {
                if (e.target.closest('.modal')) {
                    // Si el formulario no tiene data-ajax="true" (o similar), prevenimos
                    // En nuestro caso, manejamos todo con fetch manual, así que prevenimos SIEMPRE
                    // excepto si explícitamente queremos permitirlo (raro en este diseño)
                    // e.preventDefault(); 
                    // YA LO MANEJAMOS EN EL SCRIPT ESPECIFICO DE CADA MODAL, 
                    // PERO ESTO ES UNA CAPA EXTRA DE SEGURIDAD
                    console.log('Submit detectado en modal global');
                }
            });

            // Manejo de cierre de modales
            document.body.addEventListener('hide.bs.modal', function(e) {
                // Aquí podríamos agregar lógica para prevenir cierre si hay cambios
                // Por ahora solo logueamos
                console.log('Modal cerrándose:', e.target.id);
            });
        });
    </script>
}
