@model List<VentaFacil.web.Models.Dto.PedidoDto>
@using VentaFacil.web.Models.Enum
@using VentaFacil.web.Models.Enums

@{
    Layout = "_LayoutPlantilla";
    ViewData["Title"] = "Panel de Cocina";
}

<!-- ========== table components start ========== -->
<section class="table-components">
    <div class="container-fluid">
        <!-- ========== title-wrapper start ========== -->
        <div class="title-wrapper pt-30">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2>Panel de Cocina</h2>
                    </div>
                </div>
                <!-- end col -->
                <div class="col-md-6">
                    <div class="breadcrumb-wrapper">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#0">Dashboard</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a asp-controller="Pedidos" asp-action="Index">Pedidos</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Cocina
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== title-wrapper end ========== -->
        <!-- ========== tables-wrapper start ========== -->
        <div class="tables-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Header con estadísticas -->
                    <div class="card-style mb-30">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="title">
                                    <h6>Gestión de Pedidos en Cocina</h6>
                                    <p class="text-sm mb-0">
                                        Control y seguimiento de pedidos en preparación
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex justify-content-end align-items-center gap-3">
                                    <span class="status-btn active-btn" id="contadorPedidos">
                                        <i class="lni lni-timer me-1"></i>
                                        @Model.Count(p => p.Estado == PedidoEstado.EnPreparacion) en preparación /
                                        @Model.Count(p => p.Estado == PedidoEstado.Listo) listos
                                    </span>
                                    <a asp-controller="Pedidos" asp-action="Index" class="main-btn primary-btn-outline btn-hover btn-sm">
                                        <i class="lni lni-list me-1"></i> Ver Todos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros rápidos -->
                    <div class="card-style mb-30">
                        <div class="row g-3">
                            <div class="col-xl-4 col-lg-6 col-md-6">
                                <div class="input-style-1">
                                    <label>Buscar por cliente o mesa</label>
                                    <input type="text" id="filtroBusqueda" placeholder="🔍 Buscar...">
                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-6 col-md-6">
                                <div class="select-style-1">
                                    <label>Filtrar por estado</label>
                                    <div class="select-position">
                                        <select id="filtroEstado">
                                            <option value="">Todos los estados</option>
                                            <option value="EnPreparacion">En Preparación</option>
                                            <option value="Listo">Listo para entregar</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-lg-6 col-md-6">
                                <div class="select-style-1">
                                    <label>Filtrar por modalidad</label>
                                    <div class="select-position">
                                        <select id="filtroModalidad">
                                            <option value="">Todas las modalidades</option>
                                            <option value="EnMesa">En Mesa</option>
                                            <option value="ParaLlevar">Para Llevar</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-6 col-md-6">
                                <div class="input-style-1">
                                    <label>&nbsp;</label>
                                    <button class="main-btn primary-btn-outline btn-hover w-100" onclick="limpiarFiltros()">
                                        <i class="lni lni-reload me-1"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de pedidos -->
                    <div class="row" id="gridPedidos">
                        @foreach (var pedido in Model.Where(p => p.Estado == PedidoEstado.EnPreparacion || p.Estado == PedidoEstado.Listo))
                        {
                            <div class="col-xl-4 col-lg-6 col-md-6 mb-4 pedido-card"
                                 data-estado="@pedido.Estado"
                                 data-modalidad="@pedido.Modalidad"
                                 data-cliente="@pedido.Cliente?.ToLower()"
                                 data-mesa="@pedido.NumeroMesa">
                                <div class="card-style @(pedido.Estado == PedidoEstado.Listo ? "border-success" : "border-warning") h-100">
                                    <!-- Header de la card -->
                                    <div class="card-header @(pedido.Estado == PedidoEstado.Listo ? "bg-success" : "bg-warning") text-white d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">Pedido #@pedido.Id_Venta</h6>
                                            <small class="opacity-75">@pedido.Fecha.ToString("HH:mm")</small>
                                        </div>
                                        <span class="badge bg-light text-dark opacity-90">
                                            @pedido.Items.Sum(i => i.Cantidad) items
                                        </span>
                                    </div>

                                    <!-- Body de la card -->
                                    <div class="card-content">
                                        <!-- Información del cliente -->
                                        <div class="mb-4">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong class="text-lg">
                                                    <i class="lni lni-user me-1"></i>@(pedido.Cliente ?? "Cliente no especificado")
                                                </strong>
                                                <span class="status-btn @(pedido.Modalidad == ModalidadPedido.EnMesa ? "info-btn" : "secondary-btn")">
                                                    @if (pedido.Modalidad == ModalidadPedido.EnMesa)
                                                    {
                                                        <i class="lni lni-restaurant me-1"></i>
                                                        @:Mesa @pedido.NumeroMesa
                                                    }
                                                    else
                                                    {
                                                        <i class="lni lni-takeaway me-1"></i>
                                                        @:Para Llevar
                                                    }
                                                </span>
                                            </div>
                                            <div class="d-flex justify-content-between text-sm text-muted">
                                                <span>Hora: @pedido.Fecha.ToString("HH:mm")</span>
                                                <span>Tiempo: <span id="tiempo_@pedido.Id_Venta">--:--</span></span>
                                            </div>
                                        </div>

                                        <!-- Lista de productos -->
                                        <div class="mb-4">
                                            <h6 class="border-bottom pb-2 mb-3">
                                                <i class="lni lni-cart-full me-1"></i>Productos:
                                            </h6>
                                            <div class="productos-list" style="max-height: 200px; overflow-y: auto;">
                                                @foreach (var item in pedido.Items)
                                                {
                                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                                        <div class="d-flex align-items-center">
                                                            <span class="status-btn active-btn me-2">@item.Cantidad</span>
                                                            <span class="text-sm">@item.NombreProducto</span>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(item.Notas))
                                                        {
                                                            <span class="badge bg-info" title="@item.Notas">
                                                                <i class="lni lni-notepad"></i>
                                                            </span>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <!-- Notas especiales -->
                                        @if (!string.IsNullOrEmpty(pedido.Notas))
                                        {
                                            <div class="alert alert-warning py-2 mb-3">
                                                <div class="d-flex">
                                                    <i class="lni lni-notepad me-2"></i>
                                                    <small><strong>Notas:</strong> @pedido.Notas</small>
                                                </div>
                                            </div>
                                        }

                                        <!-- Tiempo transcurrido -->
                                        <div class="bg-light p-3 rounded text-center mb-3">
                                            <small class="text-muted d-block">Tiempo en cocina:</small>
                                            <div class="fw-bold text-primary fs-5" id="timer_@pedido.Id_Venta">00:00</div>
                                        </div>
                                    </div>

                                    <!-- Footer de la card -->
                                    <div class="card-footer mt-auto">
                                        @if (pedido.Estado == PedidoEstado.EnPreparacion)
                                        {
                                            <div class="d-grid gap-2">
                                                <button class="main-btn success-btn btn-hover" onclick="marcarComoListo(@pedido.Id_Venta)">
                                                    <i class="lni lni-checkmark-circle me-2"></i> Marcar como Listo
                                                </button>
                                                <button class="main-btn primary-btn-outline btn-hover btn-sm" onclick="agregarNota(@pedido.Id_Venta)">
                                                    <i class="lni lni-pencil-alt me-1"></i> Agregar Nota
                                                </button>
                                            </div>
                                        }
                                        else if (pedido.Estado == PedidoEstado.Listo)
                                        {
                                            <div class="d-grid gap-2">
                                                <button class="main-btn success-btn btn-hover" disabled>
                                                    <i class="lni lni-checkmark-circle me-2"></i> PEDIDO LISTO
                                                </button>
                                                <button class="main-btn info-btn-outline btn-hover btn-sm" onclick="marcarComoEntregado(@pedido.Id_Venta)">
                                                    <i class="lni lni-delivery me-1"></i> Marcar como Entregado
                                                </button>
                                                <small class="text-center text-muted mt-1">Esperando entrega al cliente</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (!Model.Any(p => p.Estado == PedidoEstado.EnPreparacion || p.Estado == PedidoEstado.Listo))
                    {
                        <div class="card-style text-center py-5">
                            <div class="mb-4">
                                <i class="lni lni-chef-hat text-muted" style="font-size: 4rem;"></i>
                            </div>
                            <h4 class="text-muted mb-3">No hay pedidos en cocina</h4>
                            <p class="text-muted mb-4">Los pedidos aparecerán aquí cuando sean enviados a cocina</p>
                            <a asp-controller="Pedidos" asp-action="Index" class="main-btn primary-btn btn-hover">
                                <i class="lni lni-list me-2"></i> Ver Todos los Pedidos
                            </a>
                        </div>
                    }
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== tables-wrapper end ========== -->
    </div>
    <!-- end container -->
</section>
<!-- ========== table components end ========== -->
<!-- Modal para agregar notas -->
<div class="modal fade" id="modalNota" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="lni lni-pencil-alt me-2"></i> Agregar Nota al Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pedidoIdNota">
                <div class="input-style-1">
                    <label class="form-label">Nota para el pedido:</label>
                    <textarea class="form-control" id="textoNota" rows="3" placeholder="Ej: Sin picante, bien cocido, etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="main-btn primary-btn-outline btn-hover" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="main-btn primary-btn btn-hover" onclick="guardarNota()">
                    <i class="lni lni-save me-1"></i> Guardar Nota
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Función para obtener el token anti-forgery
        function getAntiForgeryToken() {
            console.log('=== BUSCANDO TOKEN ANTI-FORGERY ===');

            // Buscar en diferentes ubicaciones posibles
            const selectors = [
                'input[name="__RequestVerificationToken"]',
                'form input[name="__RequestVerificationToken"]',
                'body input[name="__RequestVerificationToken"]'
            ];

            for (const selector of selectors) {
                const tokenElement = document.querySelector(selector);
                if (tokenElement && tokenElement.value) {
                    console.log('✅ Token encontrado con selector:', selector);
                    return tokenElement.value;
                }
            }

            console.error('❌ NO SE PUDO ENCONTRAR EL TOKEN ANTI-FORGERY');

            // Debug adicional
            const allInputs = document.querySelectorAll('input');
            console.log('Total de inputs en la página:', allInputs.length);

            return '';
        }

        // Timers para cada pedido
        function iniciarTimers() {
            @foreach (var pedido in Model.Where(p => p.Estado == PedidoEstado.EnPreparacion || p.Estado == PedidoEstado.Listo))
            {
                    <text>
                    iniciarTimer(@pedido.Id_Venta, new Date('@pedido.Fecha.ToString("yyyy-MM-ddTHH:mm:ss")'));
                    </text>
            }
        }

        function iniciarTimer(pedidoId, fechaCreacion) {
            function actualizarTiempo() {
                const ahora = new Date();
                const diferencia = Math.floor((ahora - fechaCreacion) / 1000); // segundos
                const minutos = Math.floor(diferencia / 60);
                const segundos = diferencia % 60;

                const tiempoFormateado = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
                const timerElement = document.getElementById(`timer_${pedidoId}`);
                const tiempoElement = document.getElementById(`tiempo_${pedidoId}`);

                if (timerElement) timerElement.textContent = tiempoFormateado;
                if (tiempoElement) tiempoElement.textContent = tiempoFormateado;
            }

            actualizarTiempo();
            setInterval(actualizarTiempo, 1000);
        }

        // Filtros
        document.getElementById('filtroBusqueda').addEventListener('input', aplicarFiltros);
        document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroModalidad').addEventListener('change', aplicarFiltros);

        function aplicarFiltros() {
            const busqueda = document.getElementById('filtroBusqueda').value.toLowerCase();
            const estado = document.getElementById('filtroEstado').value;
            const modalidad = document.getElementById('filtroModalidad').value;

            const cards = document.querySelectorAll('.pedido-card');
            let visibleCount = 0;
            let enPreparacionCount = 0;
            let listosCount = 0;

            cards.forEach(card => {
                const cardEstado = card.getAttribute('data-estado');
                const cardModalidad = card.getAttribute('data-modalidad');
                const cardCliente = card.getAttribute('data-cliente') || '';
                const cardMesa = card.getAttribute('data-mesa') || '';

                const coincideBusqueda = cardCliente.includes(busqueda) || cardMesa.includes(busqueda);
                const coincideEstado = !estado || cardEstado === estado;
                const coincideModalidad = !modalidad || cardModalidad === modalidad;

                if (coincideBusqueda && coincideEstado && coincideModalidad) {
                    card.style.display = 'block';
                    visibleCount++;
                    if (cardEstado === 'EnPreparacion') enPreparacionCount++;
                    if (cardEstado === 'Listo') listosCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('contadorPedidos').textContent =
                `${enPreparacionCount} en preparación / ${listosCount} listos`;
        }

        function limpiarFiltros() {
            document.getElementById('filtroBusqueda').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroModalidad').value = '';
            aplicarFiltros();
        }

        // Funciones de cocina
        async function marcarComoListo(pedidoId) {
            console.log('=== INICIANDO MARCAR COMO LISTO ===');
            console.log('Pedido ID:', pedidoId);

            const token = getAntiForgeryToken();

            if (!token) {
                alert('Error de seguridad: No se pudo verificar la solicitud');
                return;
            }

            if (confirm('¿Confirmar que este pedido está listo para entregar?')) {
                try {
                    const requestBody = {
                        pedidoId: pedidoId
                    };

                    const response = await fetch('/Pedidos/MarcarComoListo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': token,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        let errorMessage = `Error ${response.status}`;
                        try {
                            const errorText = await response.text();
                            errorMessage += ` - ${errorText || 'Respuesta vacía'}`;
                        } catch {
                            errorMessage += ' - No se pudo leer respuesta';
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    console.log('✅ Response data:', data);

                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('❌ Error completo:', error);
                    alert('Error al marcar como listo: ' + error.message);
                }
            }
        }

        async function marcarComoEntregado(pedidoId) {
            console.log('=== INICIANDO MARCAR COMO ENTREGADO ===');
            console.log('Pedido ID:', pedidoId);

            const token = getAntiForgeryToken();

            if (!token) {
                alert('Error de seguridad: No se pudo verificar la solicitud');
                return;
            }

            if (confirm('¿Confirmar que este pedido fue entregado al cliente?')) {
                try {
                    const requestBody = {
                        pedidoId: pedidoId
                    };

                    const response = await fetch('/Pedidos/MarcarComoEntregado', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': token,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('❌ Error response text:', errorText);
                        throw new Error(`Error del servidor: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('✅ Response data:', data);

                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('❌ Error completo:', error);
                    alert('Error al marcar como entregado: ' + error.message);
                }
            }
        }

        function agregarNota(pedidoId) {
            document.getElementById('pedidoIdNota').value = pedidoId;
            document.getElementById('textoNota').value = '';
            new bootstrap.Modal(document.getElementById('modalNota')).show();
        }

        async function guardarNota() {
            const pedidoId = document.getElementById('pedidoIdNota').value;
            const nota = document.getElementById('textoNota').value;

            if (!nota.trim()) {
                alert('Por favor ingresa una nota');
                return;
            }

            try {
                const response = await fetch('/Pedidos/AgregarNotaCocina', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        id: parseInt(pedidoId),
                        nota: nota
                    })
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                const data = await response.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNota')).hide();
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar nota: ' + error.message);
            }
        }

        // Auto-refresh cada 30 segundos
        setInterval(() => {
            fetch(`/Pedidos/ObtenerPedidosCocina`)
                .then(response => response.json())
                .then(data => {
                    if (data.actualizado && data.count !== @Model.Count) {
                        console.log('Actualizando vista de cocina...');
                        location.reload();
                    }
                })
                .catch(error => console.log('Error en auto-refresh:', error));
        }, 30000);

        // Iniciar cuando la página cargue
        document.addEventListener('DOMContentLoaded', function() {
            iniciarTimers();
            aplicarFiltros();
        });
    </script>
}

<style>
    .pedido-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .pedido-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

    .productos-list::-webkit-scrollbar {
        width: 6px;
    }

    .productos-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .productos-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

        .productos-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

    .card-style.border-warning {
        border-left: 4px solid #ffc107;
    }

    .card-style.border-success {
        border-left: 4px solid #198754;
    }

    .card-header.bg-warning {
        background: linear-gradient(135deg, #ffc107, #ffb300) !important;
    }

    .card-header.bg-success {
        background: linear-gradient(135deg, #198754, #157347) !important;
    }
</style>