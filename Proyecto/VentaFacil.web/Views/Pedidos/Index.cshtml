@using VentaFacil.web.Models.Enums
@{
    Layout = "_LayoutPlantilla";
    ViewData["Title"] = "Pedidos";
    var pedidosBorrador = ViewBag.PedidosBorrador as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
    var pedidosPendientes = ViewBag.PedidosPendientes as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
    var pedidosListos = ViewBag.PedidosListos as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
    var pedidosEntregados = ViewBag.PedidosEntregados as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
    var pedidosCancelados = ViewBag.PedidosCancelados as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
    var todosLosPedidos = ViewBag.TodosLosPedidos as List<VentaFacil.web.Models.Dto.PedidoDto> ?? new List<VentaFacil.web.Models.Dto.PedidoDto>();
}

<!-- ========== table components start ========== -->
<section class="table-components">
    <div class="container-fluid">
        <!-- ========== title-wrapper start ========== -->
        <div class="title-wrapper pt-30">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2>Gestión de Pedidos</h2>
                    </div>
                </div>
                <!-- end col -->
                <div class="col-md-6">
                    <div class="breadcrumb-wrapper">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#0">Dashboard</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Pedidos
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== title-wrapper end ========== -->
        <!-- ========== tables-wrapper start ========== -->
        <div class="tables-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Alertas del sistema -->
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- Header de acciones -->
                    <div class="card-style mb-30">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="title">
                                    <h6>Resumen del Sistema</h6>
                                    <p class="text-sm mb-0">
                                        Usuario: <strong>@User.Identity?.Name</strong>
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="d-flex justify-content-end align-items-center gap-2">
                                    <span class="badge bg-light text-dark" id="contadorTiempo">
                                        <i class="lni lni-timer"></i>
                                        Actualizado: <span id="tiempoActualizado">ahora</span>
                                    </span>
                                    <a asp-action="Crear" class="main-btn primary-btn btn-hover">
                                        <i class="lni lni-plus"></i> Nuevo Pedido
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas rápidas -->
                    <div class="row">
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-primary bg-opacity-10 text-primary">
                                        <i class="lni lni-draft"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1" id="estadisticaBorrador">@pedidosBorrador.Count</h4>
                                        <span class="text-sm text-medium">En Borrador</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-warning bg-opacity-10 text-warning">
                                        <i class="lni lni-chef-hat"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1" id="estadisticaCocina">@pedidosPendientes.Count</h4>
                                        <span class="text-sm text-medium">En Cocina</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-info bg-opacity-10 text-info">
                                        <i class="lni lni-checkmark-circle"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1" id="estadisticaListos">@pedidosListos.Count</h4>
                                        <span class="text-sm text-medium">Listos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-success bg-opacity-10 text-success">
                                        <i class="lni lni-delivery"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1" id="estadisticaEntregados">@pedidosEntregados.Count</h4>
                                        <span class="text-sm text-medium">Entregados</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-danger bg-opacity-10 text-danger">
                                        <i class="lni lni-close"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1" id="estadisticaCancelados">@pedidosCancelados.Count</h4>
                                        <span class="text-sm text-medium">Cancelados</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-lg-4 col-md-6 col-sm-6">
                            <div class="card-style mb-30">
                                <div class="d-flex align-items-center">
                                    <div class="icon bg-secondary bg-opacity-10 text-secondary">
                                        <i class="lni lni-cart-full"></i>
                                    </div>
                                    <div class="content ms-3">
                                        <h4 class="mb-1">@todosLosPedidos.Count</h4>
                                        <span class="text-sm text-medium">Total</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos en Borrador -->
                    <div id="seccionBorrador">
                        @if (pedidosBorrador.Any())
                        {
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6 class="mb-1">📝 Pedidos en Borrador</h6>
                                        <p class="text-sm mb-0">
                                            Pedidos en proceso de edición
                                        </p>
                                    </div>
                                    
                                    <span class="status-btn active-btn" id="contadorBorrador">@pedidosBorrador.Count pendientes</span>
                                </div>
                                <div class="table-wrapper table-responsive">
                                    <table class="table striped-table">
                                        <thead>
                                            <tr>
                                                <th class="min-width">
                                                    <h6>ID</h6>
                                                </th>
                                                <th>
                                                    <h6>Cliente</h6>
                                                </th>
                                                <th>
                                                    <h6>Modalidad</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Productos</h6>
                                                </th>
                                                <th class="text-end">
                                                    <h6>Total</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Acciones</h6>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var pedido in pedidosBorrador)
                                            {
                                                <tr id="pedido-@pedido.Id_Venta" data-estado="@pedido.Estado">
                                                    <td class="min-width">
                                                        <p class="fw-bold text-primary">#@pedido.Id_Venta</p>
                                                    </td>
                                                    <td>
                                                        @if (string.IsNullOrEmpty(pedido.Cliente))
                                                        {
                                                            <span class="text-muted">Sin nombre</span>
                                                        }
                                                        else
                                                        {
                                                            @pedido.Cliente
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (pedido.Modalidad == VentaFacil.web.Models.Enum.ModalidadPedido.EnMesa)
                                                        {
                                                            <span class="status-btn info-btn">
                                                                <i class="lni lni-restaurant me-1"></i> Mesa @pedido.NumeroMesa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="status-btn close-btn">
                                                                <i class="lni lni-takeaway me-1"></i> Para Llevar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary rounded-pill">@pedido.Items.Count</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <p class="fw-bold text-success">$@pedido.Total.ToString("N2")</p>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action">
                                                            <a asp-action="Editar" asp-route-id="@pedido.Id_Venta"
                                                               class="text-warning me-2" title="Continuar editando">
                                                                <i class="lni lni-pencil"></i>
                                                            </a>
                                                            <button class="text-success me-2" onclick="iniciarPreparacion(@pedido.Id_Venta)" title="Enviar a cocina">
                                                                <i class="lni lni-chef-hat"></i>
                                                            </button>
                                                            <button class="text-danger" onclick="cancelarPedido(@pedido.Id_Venta)" title="Cancelar pedido">
                                                                <i class="lni lni-close"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pedidos Pendientes (Enviados a Cocina) -->
                    <div id="seccionPendientes">
                        @if (pedidosPendientes.Any())
                        {
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6 class="mb-1">🔥 Pedidos Enviados a Cocina</h6>
                                        <p class="text-sm mb-0">
                                            Pedidos en proceso de preparación
                                        </p>
                                    </div>
                                    
                                    <span class="status-btn warning-btn" id="contadorPendientes">@pedidosPendientes.Count en cocina</span>
                                </div>
                                <div class="table-wrapper table-responsive">
                                    <table class="table striped-table">
                                        <thead>
                                            <tr>
                                                <th class="min-width">
                                                    <h6>ID</h6>
                                                </th>
                                                <th>
                                                    <h6>Cliente</h6>
                                                </th>
                                                <th>
                                                    <h6>Modalidad</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Productos</h6>
                                                </th>
                                                <th class="text-end">
                                                    <h6>Total</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Estado</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Acciones</h6>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var pedido in pedidosPendientes)
                                            {
                                                <tr id="pedido-@pedido.Id_Venta" data-estado="@pedido.Estado">
                                                    <td class="min-width">
                                                        <p class="fw-bold text-primary">#@pedido.Id_Venta</p>
                                                    </td>
                                                    <td>
                                                        @if (string.IsNullOrEmpty(pedido.Cliente))
                                                        {
                                                            <span class="text-muted">Sin nombre</span>
                                                        }
                                                        else
                                                        {
                                                            @pedido.Cliente
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (pedido.Modalidad == VentaFacil.web.Models.Enum.ModalidadPedido.EnMesa)
                                                        {
                                                            <span class="status-btn info-btn">
                                                                <i class="lni lni-restaurant me-1"></i> Mesa @pedido.NumeroMesa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="status-btn close-btn">
                                                                <i class="lni lni-takeaway me-1"></i> Para Llevar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary rounded-pill">@pedido.Items.Count</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <p class="fw-bold text-success">$@pedido.Total.ToString("N2")</p>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@pedido.Fecha.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="status-btn @GetBadgeClass(pedido.Estado)" id="estado-@pedido.Id_Venta">
                                                            @GetEstadoText(pedido.Estado)
                                                        </span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action">
                                                            <a asp-action="Editar" asp-route-id="@pedido.Id_Venta"
                                                               class="text-info me-2" title="Ver detalles">
                                                                <i class="lni lni-eye"></i>
                                                            </a>
                                                            <button class="text-success me-2" onclick="marcarComoListo(@pedido.Id_Venta)" title="Marcar como listo">
                                                                <i class="lni lni-checkmark-circle"></i>
                                                            </button>
                                                            <button class="text-danger" onclick="cancelarPedido(@pedido.Id_Venta)" title="Cancelar pedido">
                                                                <i class="lni lni-close"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pedidos Listos -->
                    <div id="seccionListos">
                        @if (pedidosListos.Any())
                        {
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6 class="mb-1">✅ Pedidos Listos</h6>
                                        <p class="text-sm mb-0">
                                            Pedidos terminados y listos para entregar
                                        </p>
                                    </div>
                                    
                                    <span class="status-btn success-btn" id="contadorListos">@pedidosListos.Count listos</span>
                                </div>
                                <div class="table-wrapper table-responsive">
                                    <table class="table striped-table">
                                        <thead>
                                            <tr>
                                                <th class="min-width">
                                                    <h6>ID</h6>
                                                </th>
                                                <th>
                                                    <h6>Cliente</h6>
                                                </th>
                                                <th>
                                                    <h6>Modalidad</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Productos</h6>
                                                </th>
                                                <th class="text-end">
                                                    <h6>Total</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Pedido</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Listo</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Acciones</h6>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var pedido in pedidosListos)
                                            {
                                                <tr id="pedido-@pedido.Id_Venta" data-estado="@pedido.Estado">
                                                    <td class="min-width">
                                                        <p class="fw-bold text-primary">#@pedido.Id_Venta</p>
                                                    </td>
                                                    <td>
                                                        @if (string.IsNullOrEmpty(pedido.Cliente))
                                                        {
                                                            <span class="text-muted">Sin nombre</span>
                                                        }
                                                        else
                                                        {
                                                            @pedido.Cliente
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (pedido.Modalidad == VentaFacil.web.Models.Enum.ModalidadPedido.EnMesa)
                                                        {
                                                            <span class="status-btn info-btn">
                                                                <i class="lni lni-restaurant me-1"></i> Mesa @pedido.NumeroMesa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="status-btn close-btn">
                                                                <i class="lni lni-takeaway me-1"></i> Para Llevar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary rounded-pill">@pedido.Items.Count</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <p class="fw-bold text-success">$@pedido.Total.ToString("N2")</p>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@pedido.Fecha.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@(pedido.FechaActualizacion?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action">
                                                            <a asp-action="Editar" asp-route-id="@pedido.Id_Venta"
                                                               class="text-info me-2" title="Ver detalles">
                                                                <i class="lni lni-eye"></i>
                                                            </a>
                                                            <button class="text-success" onclick="marcarEntregado(@pedido.Id_Venta)" title="Marcar como entregado">
                                                                <i class="lni lni-checkmark-circle"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pedidos Entregados -->
                    <div id="seccionEntregados">
                        @if (pedidosEntregados.Any())
                        {
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6 class="mb-1">📦 Pedidos Entregados</h6>
                                        <p class="text-sm mb-0">
                                            Pedidos completados y entregados al cliente
                                        </p>
                                    </div>
                                   
                                    <span class="status-btn info-btn" id="contadorEntregados">@pedidosEntregados.Count entregados</span>
                                </div>
                                <div class="table-wrapper table-responsive">
                                    <table class="table striped-table">
                                        <thead>
                                            <tr>
                                                <th class="min-width">
                                                    <h6>ID</h6>
                                                </th>
                                                <th>
                                                    <h6>Cliente</h6>
                                                </th>
                                                <th>
                                                    <h6>Modalidad</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Productos</h6>
                                                </th>
                                                <th class="text-end">
                                                    <h6>Total</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Pedido</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Entrega</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Acciones</h6>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var pedido in pedidosEntregados)
                                            {
                                                <tr id="pedido-@pedido.Id_Venta" data-estado="@pedido.Estado">
                                                    <td class="min-width">
                                                        <p class="fw-bold text-primary">#@pedido.Id_Venta</p>
                                                    </td>
                                                    <td>
                                                        @if (string.IsNullOrEmpty(pedido.Cliente))
                                                        {
                                                            <span class="text-muted">Sin nombre</span>
                                                        }
                                                        else
                                                        {
                                                            @pedido.Cliente
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (pedido.Modalidad == VentaFacil.web.Models.Enum.ModalidadPedido.EnMesa)
                                                        {
                                                            <span class="status-btn info-btn">
                                                                <i class="lni lni-restaurant me-1"></i> Mesa @pedido.NumeroMesa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="status-btn close-btn">
                                                                <i class="lni lni-takeaway me-1"></i> Para Llevar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary rounded-pill">@pedido.Items.Count</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <p class="fw-bold text-success">$@pedido.Total.ToString("N2")</p>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@pedido.Fecha.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@(pedido.FechaActualizacion?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action">
                                                            <a asp-action="Editar" asp-route-id="@pedido.Id_Venta"
                                                               class="text-info" title="Ver detalles">
                                                                <i class="lni lni-eye"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pedidos Cancelados -->
                    <div id="seccionCancelados">
                        @if (pedidosCancelados.Any())
                        {
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6 class="mb-1">❌ Pedidos Cancelados</h6>
                                        <p class="text-sm mb-0">
                                            Pedidos que han sido cancelados
                                        </p>
                                    </div>
                                    
                                    <span class="status-btn danger-btn" id="contadorCancelados">@pedidosCancelados.Count cancelados</span>
                                </div>
                                <div class="table-wrapper table-responsive">
                                    <table class="table striped-table">
                                        <thead>
                                            <tr>
                                                <th class="min-width">
                                                    <h6>ID</h6>
                                                </th>
                                                <th>
                                                    <h6>Cliente</h6>
                                                </th>
                                                <th>
                                                    <h6>Modalidad</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Productos</h6>
                                                </th>
                                                <th class="text-end">
                                                    <h6>Total</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Pedido</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Fecha Cancelación</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Motivo</h6>
                                                </th>
                                                <th class="text-center">
                                                    <h6>Acciones</h6>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var pedido in pedidosCancelados)
                                            {
                                                <tr id="pedido-@pedido.Id_Venta" data-estado="@pedido.Estado">
                                                    <td class="min-width">
                                                        <p class="fw-bold text-primary">#@pedido.Id_Venta</p>
                                                    </td>
                                                    <td>
                                                        @if (string.IsNullOrEmpty(pedido.Cliente))
                                                        {
                                                            <span class="text-muted">Sin nombre</span>
                                                        }
                                                        else
                                                        {
                                                            @pedido.Cliente
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (pedido.Modalidad == VentaFacil.web.Models.Enum.ModalidadPedido.EnMesa)
                                                        {
                                                            <span class="status-btn info-btn">
                                                                <i class="lni lni-restaurant me-1"></i> Mesa @pedido.NumeroMesa
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="status-btn close-btn">
                                                                <i class="lni lni-takeaway me-1"></i> Para Llevar
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary rounded-pill">@pedido.Items.Count</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <p class="fw-bold text-danger">$@pedido.Total.ToString("N2")</p>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@pedido.Fecha.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@(pedido.FechaActualizacion?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <small class="text-muted">@(pedido.MotivoCancelacion ?? "Sin especificar")</small>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="action">
                                                            <a asp-action="Editar" asp-route-id="@pedido.Id_Venta"
                                                               class="text-info" title="Ver detalles">
                                                                <i class="lni lni-eye"></i>
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>

                    @if (!pedidosBorrador.Any() && !pedidosPendientes.Any() && !pedidosListos.Any() && !pedidosEntregados.Any() && !pedidosCancelados.Any())
                    {
                        <div class="card-style text-center py-5" id="sinPedidos">
                            <div class="mb-4">
                                <i class="lni lni-cart-full text-muted" style="font-size: 4rem;"></i>
                            </div>
                            <h4 class="text-muted mb-3">No hay pedidos registrados</h4>
                            <p class="text-muted mb-4">Comienza creando un nuevo pedido para el cliente</p>
                            <a asp-action="Crear" class="main-btn primary-btn btn-hover">
                                <i class="lni lni-plus me-2"></i> Crear Primer Pedido
                            </a>
                        </div>
                    }

                    <!-- Información del sistema -->
                    <div class="card-style">
                        <div class="alert alert-info mb-0">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="lni lni-information fs-4 text-info"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-2">📋 Flujo de Pedidos</h6>
                                    <ul class="mb-0 ps-3 text-sm">
                                        <li><strong class="text-dark">Borrador:</strong> Pedido en proceso, puedes editarlo completamente</li>
                                        <li><strong class="text-dark">En Preparación:</strong> Pedido en cocina, no se puede modificar</li>
                                        <li><strong class="text-dark">Listo:</strong> Pedido terminado, listo para entregar</li>
                                        <li><strong class="text-dark">Entregado:</strong> Pedido completado y entregado al cliente</li>
                                        <li><strong class="text-dark">Cancelado:</strong> Pedido que ha sido cancelado por algún motivo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas del sistema -->
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- Botón para ver facturas recientes (opcional) -->
                    @if (TempData["FacturaId"] != null)
                    {
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>✅ Pago procesado exitosamente. ¿Desea ver la factura?</span>
                                <a href="@Url.Action("DetalleFactura", "Facturacion", new { facturaId = TempData["FacturaId"] })"
                                   class="btn btn-sm btn-outline-primary ms-3">
                                    <i class="lni lni-receipt me-1"></i> Ver Factura
                                </a>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== tables-wrapper end ========== -->
    </div>
    <!-- end container -->
</section>
<!-- ========== table components end ========== -->
@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        let ultimaActualizacion = new Date();
        let isUpdating = false;

        function actualizarTiempoActualizado() {
            const ahora = new Date();
            const diferencia = Math.floor((ahora - ultimaActualizacion) / 1000);

            if (diferencia < 60) {
                document.getElementById('tiempoActualizado').textContent = 'hace unos segundos';
            } else if (diferencia < 3600) {
                const minutos = Math.floor(diferencia / 60);
                document.getElementById('tiempoActualizado').textContent = `hace ${minutos} minuto${minutos > 1 ? 's' : ''}`;
            } else {
                document.getElementById('tiempoActualizado').textContent = 'hace más de 1 hora';
            }
        }

        // Función para obtener el token anti-forgery
        function getAntiForgeryToken() {
            // Buscar el token en diferentes ubicaciones
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenElement) {
                return tokenElement.value;
            }

            // Si no se encuentra, buscar en forms
            const forms = document.querySelectorAll('form');
            for (let form of forms) {
                const tokenInput = form.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) {
                    return tokenInput.value;
                }
            }

            console.error('No se pudo encontrar el token anti-forgery');
            return '';
        }

                async function marcarComoListo(pedidoId) {
            if (isUpdating) return;

            if (confirm('¿Confirmar que este pedido está listo para entregar?')) {
                isUpdating = true;
                try {
                    const response = await fetch('/Pedidos/MarcarComoListo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ PedidoId: pedidoId })
                    });

                    console.log('Respuesta status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Resultado:', result);

                        if (result.success) {
                            
                            mostrarMensaje('Pedido marcado como listo correctamente', 'success');

                            
                            setTimeout(() => {
                                location.reload();
                            }, 1000);

                        } else {
                            mostrarMensaje('Error: ' + result.message, 'error');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    mostrarMensaje('Error al procesar la solicitud: ' + error.message, 'error');
                } finally {
                    isUpdating = false;
                }
            }
        }

        async function marcarEntregado(pedidoId) {
            if (isUpdating) return;

            if (confirm('¿Estás seguro de que quieres marcar este pedido como entregado?')) {
                isUpdating = true;
                try {
                    const response = await fetch('/Pedidos/MarcarComoEntregado', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ PedidoId: pedidoId })
                    });

                    console.log('Respuesta status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Resultado:', result);

                        if (result.success) {
                            mostrarMensaje('Pedido marcado como entregado correctamente', 'success');

                            
                            setTimeout(() => {
                                location.reload();
                            }, 1000);

                        } else {
                            mostrarMensaje('Error: ' + result.message, 'error');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    mostrarMensaje('Error al procesar la solicitud: ' + error.message, 'error');
                } finally {
                    isUpdating = false;
                }
            }
        }

               async function cancelarPedido(pedidoId) {
            if (isUpdating) return;

            const razon = prompt('Ingrese el motivo de la cancelación:');
            if (razon === null) return; 
            if (razon.trim() === '') {
                mostrarMensaje('Debe ingresar un motivo para cancelar el pedido', 'error');
                return;
            }

            if (confirm('¿Está seguro de que desea cancelar este pedido?')) {
                isUpdating = true;
                try {
                    console.log('Enviando cancelación - Pedido ID:', pedidoId, 'Razón:', razon);

                    const response = await fetch('/Pedidos/CancelarPedido', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: pedidoId,
                            razon: razon
                        })
                    });

                    console.log('Respuesta status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Resultado JSON:', result);

                        if (result.success) {
                            mostrarMensaje(result.message, 'success');

                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            mostrarMensaje('Error: ' + result.message, 'error');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    mostrarMensaje('Error al cancelar el pedido: ' + error.message, 'error');
                } finally {
                    isUpdating = false;
                }
            }
        }

        async function iniciarPreparacion(pedidoId) {
            if (isUpdating) return;

            if (confirm('¿Iniciar preparación de este pedido en cocina?')) {
                isUpdating = true;
                try {
                    const token = getAntiForgeryToken();
                    console.log('Enviando IniciarPreparacion para pedido:', pedidoId);

                    const response = await fetch('/Pedidos/IniciarPreparacion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ PedidoId: pedidoId }) 
                    });

                    console.log('Respuesta status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Resultado:', result);

                        if (result.success) {
                            
                            const fila = document.getElementById(`pedido-${pedidoId}`);
                            if (fila) {
                                fila.remove();
                            }

                            await actualizarContadores();

                            mostrarMensaje('Preparación iniciada correctamente', 'success');
                        } else {
                            mostrarMensaje('Error: ' + result.message, 'error');
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    mostrarMensaje('Error al iniciar preparación: ' + error.message, 'error');
                } finally {
                    isUpdating = false;
                }
            }
        }

        async function actualizarContadores() {
            try {
                const response = await fetch('/Pedidos/ObtenerResumenPedidos');
                if (!response.ok) throw new Error('Error en la respuesta');

                const data = await response.json();

                if (data.actualizado) {
                    // Actualizar contadores de estadísticas
                    actualizarElementoTexto('estadisticaBorrador', data.estadisticas.borrador);
                    actualizarElementoTexto('estadisticaCocina', data.estadisticas.enCocina);
                    actualizarElementoTexto('estadisticaListos', data.estadisticas.listos);
                    actualizarElementoTexto('estadisticaEntregados', data.estadisticas.entregados);
                    actualizarElementoTexto('estadisticaCancelados', data.estadisticas.cancelados);

                    // Actualizar contadores de secciones
                    actualizarContadorSeccion('contadorBorrador', data.estadisticas.borrador, 'pendientes');
                    actualizarContadorSeccion('contadorPendientes', data.estadisticas.enCocina, 'en cocina');
                    actualizarContadorSeccion('contadorListos', data.estadisticas.listos, 'listos');
                    actualizarContadorSeccion('contadorEntregados', data.estadisticas.entregados, 'entregados');
                    actualizarContadorSeccion('contadorCancelados', data.estadisticas.cancelados, 'cancelados');

                    // Ocultar/mostrar secciones vacías
                    actualizarVisibilidadSecciones(data.estadisticas);

                    ultimaActualizacion = new Date();
                    actualizarTiempoActualizado();
                }
            } catch (error) {
                console.error('Error actualizando contadores:', error);
            }
        }

        function actualizarElementoTexto(elementId, texto) {
            const elemento = document.getElementById(elementId);
            if (elemento) {
                elemento.textContent = texto;
            }
        }

        function actualizarContadorSeccion(elementId, cantidad, texto) {
            const elemento = document.getElementById(elementId);
            if (elemento) {
                elemento.textContent = `${cantidad} ${texto}`;
            }
        }

        function actualizarVisibilidadSecciones(estadisticas) {
            const secciones = {
                'seccionBorrador': estadisticas.borrador > 0,
                'seccionPendientes': estadisticas.enCocina > 0,
                'seccionListos': estadisticas.listos > 0,
                'seccionEntregados': estadisticas.entregados > 0,
                'seccionCancelados': estadisticas.cancelados > 0
            };

            for (const [seccionId, tieneElementos] of Object.entries(secciones)) {
                const seccion = document.getElementById(seccionId);
                if (seccion) {
                    seccion.style.display = tieneElementos ? 'block' : 'none';
                }
            }

            
            const sinPedidos = document.getElementById('sinPedidos');
            const totalPedidos = Object.values(estadisticas).reduce((a, b) => a + b, 0);
            if (sinPedidos) {
                sinPedidos.style.display = totalPedidos === 0 ? 'block' : 'none';
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            
            const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            const container = document.querySelector('.tables-wrapper .row .col-lg-12');
            if (container) {
                container.insertAdjacentHTML('afterbegin', alertHtml);

                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }

        async function verificarCambiosCompletos() {
            if (isUpdating) return;

            try {
                const response = await fetch('/Pedidos/ObtenerResumenPedidos');
                if (!response.ok) throw new Error('Error en la respuesta');

                const data = await response.json();

                if (data.actualizado && data.cambiosSignificativos) {
                    console.log('Cambios significativos detectados, recargando página...');
                    location.reload();
                } else if (data.actualizado) {
                    await actualizarContadores();
                }
            } catch (error) {
                console.error('Error verificando cambios:', error);
            }
        }

        function actualizarManual() {
            document.getElementById('tiempoActualizado').textContent = 'actualizando...';
            verificarCambiosCompletos();
        }

        // Actualizar contadores cada 30 segundos
        setInterval(actualizarContadores, 30000);

        // Verificar cambios completos cada 60 segundos
        setInterval(verificarCambiosCompletos, 60000);

        // Actualizar contador de tiempo cada minuto
        setInterval(actualizarTiempoActualizado, 60000);

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            actualizarTiempoActualizado();
            // Verificar cambios después de 5 segundos de cargar la página
            setTimeout(actualizarContadores, 5000);
        });
    </script>
}

@functions {
    private string GetBadgeClass(PedidoEstado estado)
    {
        return estado switch
        {
            PedidoEstado.Borrador => "secondary-btn",
            PedidoEstado.EnPreparacion => "warning-btn",
            PedidoEstado.Listo => "success-btn",
            PedidoEstado.Entregado => "info-btn",
            PedidoEstado.Cancelado => "danger-btn",
            _ => "secondary-btn"
        };
    }

    private string GetEstadoText(PedidoEstado estado)
    {
        return estado switch
        {
            PedidoEstado.Borrador => "Borrador",
            PedidoEstado.EnPreparacion => "En Cocina",
            PedidoEstado.Listo => "Listo",
            PedidoEstado.Entregado => "Entregado",
            PedidoEstado.Cancelado => "Cancelado",
            _ => estado.ToString()
        };
    }
}