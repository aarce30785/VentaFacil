@model VentaFacil.web.Models.Dto.PedidoDto
@using VentaFacil.web.Models.Enum
@using VentaFacil.web.Models.Enums

@{
    Layout = "_LayoutPlantilla";
    ViewData["Title"] = $"Editar Pedido #{Model.Id_Venta}";
    bool editable = Model.Estado == PedidoEstado.Borrador;
}

<!-- ========== table components start ========== -->
<section class="table-components">
    <div class="container-fluid">
        <!-- ========== title-wrapper start ========== -->
        <div class="title-wrapper pt-30">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2>Editar Pedido #@Model.Id_Venta</h2>
                    </div>
                </div>
                <!-- end col -->
                <div class="col-md-6">
                    <div class="breadcrumb-wrapper">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#0">Dashboard</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a asp-action="Index">Pedidos</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Editar #@Model.Id_Venta
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== title-wrapper end ========== -->
        <!-- ========== tables-wrapper start ========== -->
        <div class="tables-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Alertas del sistema -->
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <!-- Header con estado -->
                    <div class="card-style mb-30">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="title">
                                    <h6>Información del Pedido</h6>
                                    <p class="text-sm mb-0">
                                        <strong>Fecha:</strong> @Model.Fecha.ToString("dd/MM/yyyy HH:mm")
                                        @if (!string.IsNullOrEmpty(Model.Notas))
                                        {
                                            <span> | <strong>Notas:</strong> @Model.Notas</span>
                                        }
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="status-btn @GetBadgeClass(Model.Estado)" style="font-size: 1rem;">
                                    @GetEstadoText(Model.Estado)
                                </span>
                            </div>
                        </div>
                    </div>

                    @if (!editable)
                    {
                        <div class="card-style mb-30">
                            <div class="alert alert-warning mb-0">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="lni lni-warning fs-4"></i>
                                    </div>
                                    <div>
                                        @if (Model.Estado == PedidoEstado.Pendiente)
                                        {
                                            <h6 class="alert-heading mb-1">⏳ Pedido Pendiente de Pago</h6>
                                            <p class="mb-2">Este pedido está listo para proceder al pago.</p>
                                            <form method="post" asp-action="ProcederAlPago">
                                                <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                                <button type="submit" class="main-btn success-btn btn-hover btn-sm">
                                                    <i class="lni lni-credit-card me-1"></i> Proceder a Pago
                                                </button>
                                            </form>
                                        }
                                        else if (Model.Estado == PedidoEstado.EnPreparacion)
                                        {
                                            <h6 class="alert-heading mb-1">👨‍🍳 Este pedido no se puede modificar</h6>
                                            <p class="mb-2">Porque ya fue enviado a cocina y está en preparación.</p>
                                            <a asp-action="Cocina" class="main-btn primary-btn btn-hover btn-sm">
                                                <i class="lni lni-chef-hat me-1"></i> Ver en Cocina
                                            </a>
                                        }
                                        else if (Model.Estado == PedidoEstado.Listo)
                                        {
                                            <h6 class="alert-heading mb-1">✅ Pedido Listo</h6>
                                            <p class="mb-0">Este pedido está listo para ser entregado al cliente.</p>
                                        }
                                        else if (Model.Estado == PedidoEstado.Entregado)
                                        {
                                            <h6 class="alert-heading mb-1">📦 Pedido Entregado</h6>
                                            <p class="mb-0">Este pedido ya fue entregado al cliente.</p>
                                        }
                                        else if (Model.Estado == PedidoEstado.Cancelado)
                                        {
                                            <h6 class="alert-heading mb-1">❌ Pedido Cancelado</h6>
                                            <p class="mb-0">Este pedido fue cancelado.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="row">
                        <!-- Información del pedido -->
                        <div class="col-lg-6">
                            <div class="card-style mb-30">
                                <div class="title mb-30">
                                    <h6>👤 Información del Pedido</h6>
                                </div>

                                <form method="post" asp-action="ActualizarCliente" class="mb-25">
                                    <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                    <div class="input-style-1">
                                        <label class="form-label fw-bold">Cliente</label>
                                        <div class="input-group">
                                            <input type="text" name="cliente" value="@Model.Cliente"
                                                   placeholder="Nombre del cliente"
                                                   @(!editable ? "disabled" : "") />
                                            @if (editable)
                                            {
                                                <button type="submit" class="main-btn primary-btn btn-hover">
                                                    Actualizar
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </form>

                                <form method="post" asp-action="ActualizarModalidad">
                                    <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />

                                    <div class="input-style-1">
                                        <label class="form-label fw-bold">Modalidad</label>
                                        <div class="select-position">
                                            <select name="modalidad" @(!editable ? "disabled" : "")
                                                    onchange="this.form.submit()">
                                                <option value="0" selected="@(Model.Modalidad == ModalidadPedido.ParaLlevar)">📦 Para Llevar</option>
                                                <option value="1" selected="@(Model.Modalidad == ModalidadPedido.EnMesa)">🍽️ En Mesa</option>
                                            </select>
                                        </div>
                                    </div>

                                    @if (Model.Modalidad == ModalidadPedido.EnMesa)
                                    {
                                        <div class="input-style-1 mt-3">
                                            <label class="form-label fw-bold">Número de Mesa</label>
                                            <div class="input-group">
                                                <input type="number" name="numeroMesa"
                                                       value="@Model.NumeroMesa" min="1"
                                                       @(!editable ? "disabled" : "") />
                                                @if (editable)
                                                {
                                                    <button type="submit" class="main-btn primary-btn btn-hover">
                                                        Actualizar
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                </form>

                                <!-- Resumen total -->
                                <div class="mt-4 p-4 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="text-lg">Total:</strong>
                                        <span class="fw-bold text-primary fs-5">$@Model.Total.ToString("N2")</span>
                                    </div>
                                </div>
                            </div>

                            
                            <!-- Botones de acción -->
                            @if (editable)
                            {
                                <div class="card-style">
                                    @{
                                        bool tieneProductos = Model.Items.Any();
                                        bool tieneCliente = !string.IsNullOrWhiteSpace(Model.Cliente);
                                        bool mesaValida = Model.Modalidad != ModalidadPedido.EnMesa || (Model.NumeroMesa.HasValue && Model.NumeroMesa > 0);
                                        bool puedeProcederPago = tieneProductos && tieneCliente && mesaValida;
                                    }

                                    @if (!puedeProcederPago)
                                    {
                                        <div class="alert alert-warning mb-4">
                                            <h6 class="alert-heading mb-2">⚠️ Para proceder al pago necesitas:</h6>
                                            <ul class="mb-0 text-sm">
                                                <li class="@(tieneProductos ? "text-success" : "text-danger")">
                                                    <i class="lni @(tieneProductos ? "lni-checkmark-circle" : "lni-close") me-1"></i>
                                                    Al menos un producto
                                                </li>
                                                <li class="@(tieneCliente ? "text-success" : "text-danger")">
                                                    <i class="lni @(tieneCliente ? "lni-checkmark-circle" : "lni-close") me-1"></i>
                                                    Nombre del cliente
                                                </li>
                                                <li class="@(mesaValida ? "text-success" : "text-danger")">
                                                    <i class="lni @(mesaValida ? "lni-checkmark-circle" : "lni-close") me-1"></i>
                                                    @(Model.Modalidad == ModalidadPedido.EnMesa ? "Número de mesa válido" : "Modalidad configurada")
                                                </li>
                                            </ul>
                                        </div>
                                    }

                                    <!-- Botón Proceder a Pago -->
                                    <form method="post" asp-action="ProcederAlPago" class="mb-3">
                                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                        <button type="submit" class="main-btn success-btn btn-hover w-100 @(!puedeProcederPago ? "disabled" : "")"
                                                @(!puedeProcederPago ? "disabled" : "")>
                                            <i class="lni lni-credit-card me-2"></i> Proceder a Pago
                                        </button>
                                        <small class="text-muted text-sm d-block mt-1">
                                            Estado: Pendiente - Irá a facturación y luego a cocina
                                        </small>
                                    </form>

                                    <!-- Botón Guardar Borrador -->
                                    <form method="post" asp-action="GuardarBorrador" class="mb-3">
                                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                        <button type="submit" class="main-btn primary-btn-outline btn-hover w-100">
                                            <i class="lni lni-save me-2"></i> Guardar como Borrador
                                        </button>
                                        <small class="text-muted text-sm d-block mt-1">Podrás continuar después - No requiere validaciones</small>
                                    </form>

                                    <div class="border-top pt-3">
                                        <button type="button" class="main-btn danger-btn-outline btn-hover w-100"
                                                data-bs-toggle="modal" data-bs-target="#modalCancelarPedido">
                                            <i class="lni lni-close me-2"></i> Cancelar Pedido
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Productos del pedido -->
                        <div class="col-lg-6">
                            <div class="card-style mb-30">
                                <div class="title d-flex justify-content-between align-items-center mb-30">
                                    <div>
                                        <h6>🛒 Productos del Pedido</h6>
                                        <p class="text-sm mb-0">@Model.Items.Count productos agregados</p>
                                    </div>
                                    <div>
                                        <span class="status-btn active-btn">@Model.Items.Count</span>
                                        @if (editable)
                                        {
                                            <button class="main-btn primary-btn btn-hover btn-sm ms-2"
                                                    data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">
                                                <i class="lni lni-plus me-1"></i> Agregar
                                            </button>
                                        }
                                    </div>
                                </div>

                                @if (Model.Items.Any())
                                {
                                    <div class="table-wrapper table-responsive">
                                        <table class="table striped-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <h6>Producto</h6>
                                                    </th>
                                                    <th class="text-center" style="width: 150px;">
                                                        <h6>Cantidad</h6>
                                                    </th>
                                                    <th class="text-end" style="width: 120px;">
                                                        <h6>Precio Unit.</h6>
                                                    </th>
                                                    <th class="text-end" style="width: 120px;">
                                                        <h6>Subtotal</h6>
                                                    </th>
                                                    @if (editable)
                                                    {
                                                        <th class="text-center" style="width: 80px;">
                                                            <h6>Acciones</h6>
                                                        </th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.Items)
                                                {
                                                    <tr>
                                                        <td>
                                                            <div>
                                                                <strong>@item.NombreProducto</strong>
                                                                @if (!string.IsNullOrEmpty(item.Notas))
                                                                {
                                                                    <br>
                                                                    <small class="text-muted text-sm">📝 @item.Notas</small>
                                                                }
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            @if (editable)
                                                            {
                                                                <form method="post" asp-action="ActualizarCantidad" class="d-inline">
                                                                    <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                                                    <input type="hidden" name="itemId" value="@item.Id_Detalle" />
                                                                    <div class="input-group input-group-sm" style="width: 120px;">
                                                                        <input type="number" name="cantidad" value="@item.Cantidad"
                                                                               min="1" class="form-control text-center" />
                                                                        <button type="submit" class="main-btn primary-btn btn-hover btn-sm" title="Actualizar">
                                                                            <i class="lni lni-checkmark"></i>
                                                                        </button>
                                                                    </div>
                                                                </form>
                                                            }
                                                            else
                                                            {
                                                                <span class="status-btn secondary-btn">@item.Cantidad</span>
                                                            }
                                                        </td>
                                                        <td class="text-end">$@item.PrecioUnitario.ToString("N2")</td>
                                                        <td class="text-end fw-bold">$@item.Subtotal.ToString("N2")</td>
                                                        @if (editable)
                                                        {
                                                            <td class="text-center">
                                                                <form method="post" asp-action="EliminarProducto" class="d-inline">
                                                                    <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                                                    <input type="hidden" name="itemId" value="@item.Id_Detalle" />
                                                                    <button type="submit" class="text-danger bg-transparent border-0"
                                                                            title="Eliminar producto" onclick="return confirm('¿Estás seguro de eliminar este producto?')">
                                                                        <i class="lni lni-trash-can"></i>
                                                                    </button>
                                                                </form>
                                                            </td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-primary">
                                                    <th colspan="@(editable ? 3 : 2)" class="text-end">
                                                        <h6 class="mb-0">Total del Pedido:</h6>
                                                    </th>
                                                    <th class="text-end">
                                                        <h6 class="mb-0">$@Model.Total.ToString("N2")</h6>
                                                    </th>
                                                    @if (editable)
                                                    {
                                                        <th></th>
                                                    }
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <i class="lni lni-cart-full text-muted" style="font-size: 4rem;"></i>
                                        </div>
                                        <h5 class="text-muted mb-2">No hay productos en el pedido</h5>
                                        @if (editable)
                                        {
                                            <p class="text-muted mb-4">Haz clic en "Agregar" para comenzar</p>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Botón volver adicional -->
                    <div class="text-start mt-4">
                        <a asp-action="Index" class="main-btn primary-btn-outline btn-hover">
                            <i class="lni lni-arrow-left me-2"></i> Volver a la lista
                        </a>
                    </div>
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== tables-wrapper end ========== -->
    </div>
    <!-- end container -->
</section>
<!-- ========== table components end ========== -->
<!-- Modal para cancelar pedido -->
@if (editable)
{
    <div class="modal fade" id="modalCancelarPedido" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="lni lni-close text-danger me-2"></i> Cancelar Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-action="CancelarPedido" id="formCancelarPedido">
                        <input type="hidden" name="id" value="@Model.Id_Venta" />
                        <div class="input-style-1">
                            <label class="form-label fw-bold">Razón de cancelación:</label>
                            <textarea class="form-control" name="razon" rows="3"
                                  placeholder="Ej: Cliente canceló, error en el pedido, etc." required></textarea>
                        </div>
                        <div class="alert alert-warning mt-3">
                            <div class="d-flex">
                                <i class="lni lni-warning me-2"></i>
                                <small>Esta acción no se puede deshacer. El pedido será marcado como cancelado.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="main-btn primary-btn-outline btn-hover" data-bs-dismiss="modal">
                        No Cancelar
                    </button>
                    <button type="submit" form="formCancelarPedido" class="main-btn danger-btn btn-hover">
                        Confirmar Cancelación
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal para agregar productos -->
@if (editable)
{
    <div class="modal fade" id="modalAgregarProducto" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="lni lni-plus me-2"></i> Agregar Producto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-action="AgregarProducto" id="formAgregarProducto">
                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />

                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-style-1">
                                    <label class="form-label fw-bold">Seleccionar Producto</label>
                                    <div class="select-position">
                                        <select name="productoId" class="form-select" required id="selectProducto">
                                            <option value="">-- Seleccione un producto --</option>
                                            @foreach (var producto in ViewBag.Productos as List<VentaFacil.web.Models.Dto.ProductoDto> ?? new List<VentaFacil.web.Models.Dto.ProductoDto>())
                                            {
                                                <option value="@producto.Id_Producto"
                                                        data-precio="@producto.Precio"
                                                        data-nombre="@producto.Nombre"
                                                        data-descripcion="@producto.Descripcion">
                                                    @producto.Nombre - $@producto.Precio.ToString("N2")
                                                </option>
                                            }
                                        </select>
                                    </div>
                                    <small class="text-muted">Seleccione un producto de la lista</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-style-1">
                                    <label class="form-label fw-bold">Cantidad</label>
                                    <input type="number" name="cantidad" class="form-control" value="1" min="1" max="100" required />
                                </div>
                            </div>
                        </div>

                        <!-- Información del producto seleccionado -->
                        <div id="infoProducto" class="alert alert-info d-none">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <strong id="nombreProducto" class="d-block"></strong>
                                    <small class="text-muted" id="descripcionProducto"></small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="fw-bold text-primary fs-5" id="precioProducto"></span>
                                </div>
                            </div>
                        </div>

                        @if (!(ViewBag.Productos as List<VentaFacil.web.Models.Dto.ProductoDto> ?? new List<VentaFacil.web.Models.Dto.ProductoDto>()).Any())
                        {
                            <div class="alert alert-warning">
                                <div class="d-flex">
                                    <i class="lni lni-warning me-2"></i>
                                    <span>No hay productos disponibles en el catálogo.</span>
                                </div>
                            </div>
                        }

                        <div class="text-end mt-4">
                            <button type="button" class="main-btn primary-btn-outline btn-hover me-2" data-bs-dismiss="modal">
                                Cancelar
                            </button>
                            <button type="submit" class="main-btn primary-btn btn-hover" id="btnAgregar">
                                <i class="lni lni-plus me-1"></i> Agregar al Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Auto-submit para el select de modalidad
        document.querySelector('select[name="modalidad"]')?.addEventListener('change', function() {
            this.form.submit();
        });

        function mostrarErroresTempData() {
            const errorTempData = '@(TempData["Error"] ?? "")';
            const errorDetalles = '@(TempData["ErrorDetalles"] ?? "")';

            if (errorTempData) {
                let mensajeError = errorTempData;
                if (errorDetalles) {
                    mensajeError += '\n\n' + errorDetalles;
                }
                alert('❌ ' + mensajeError);

                // Limpiar TempData para que no se muestre nuevamente
                fetch('/Pedido/LimpiarTempData', { method: 'POST' });
            }
        }

        // Llamar esta función cuando se cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            mostrarErroresTempData();
        });

        // Comportamiento del modal de productos
        document.addEventListener('DOMContentLoaded', function() {
            const selectProducto = document.getElementById('selectProducto');
            const infoProducto = document.getElementById('infoProducto');
            const nombreProducto = document.getElementById('nombreProducto');
            const descripcionProducto = document.getElementById('descripcionProducto');
            const precioProducto = document.getElementById('precioProducto');
            const btnAgregar = document.getElementById('btnAgregar');
            const formAgregarProducto = document.getElementById('formAgregarProducto');

            if (selectProducto) {
                selectProducto.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];

                    if (selectedOption.value) {
                        // Mostrar información del producto
                        nombreProducto.textContent = selectedOption.getAttribute('data-nombre');
                        descripcionProducto.textContent = selectedOption.getAttribute('data-descripcion') || 'Sin descripción';
                        precioProducto.textContent = '$' + parseFloat(selectedOption.getAttribute('data-precio')).toFixed(2);

                        infoProducto.classList.remove('d-none');
                        btnAgregar.disabled = false;
                    } else {
                        infoProducto.classList.add('d-none');
                        btnAgregar.disabled = true;
                    }
                });

                // Validar formulario antes de enviar
                formAgregarProducto.addEventListener('submit', function(e) {
                    if (!selectProducto.value) {
                        e.preventDefault();
                        alert('Por favor seleccione un producto');
                        selectProducto.focus();
                    }
                });
            }

            // Resetear modal cuando se cierre
            const modal = document.getElementById('modalAgregarProducto');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    selectProducto.value = '';
                    infoProducto.classList.add('d-none');
                    btnAgregar.disabled = true;
                });
            }
        });
    </script>
}

@functions {
    private string GetBadgeClass(PedidoEstado estado)
    {
        return estado switch
        {
            PedidoEstado.Borrador => "secondary-btn",
            PedidoEstado.EnPreparacion => "warning-btn",
            PedidoEstado.Listo => "success-btn",
            PedidoEstado.Entregado => "info-btn",
            PedidoEstado.Cancelado => "danger-btn",
            _ => "secondary-btn"
        };
    }

    private string GetEstadoText(PedidoEstado estado)
    {
        return estado switch
        {
            PedidoEstado.Borrador => "Borrador",
            PedidoEstado.EnPreparacion => "En Cocina",
            PedidoEstado.Listo => "Listo",
            PedidoEstado.Entregado => "Entregado",
            PedidoEstado.Cancelado => "Cancelado",
            _ => estado.ToString()
        };
    }
}