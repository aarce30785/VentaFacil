@model VentaFacil.web.Models.Response.Admin.UsuarioListResponse


<!-- Controles de Búsqueda y Filtros Premium -->
<div class="premium-card mb-4 p-4">
    <form method="get" asp-action="IndexUsuarios" class="row g-3 align-items-center" id="filtrosForm">
        
        <!-- Stats Summary -->
        <div class="col-md-3">
             <div class="d-flex align-items-center">
                <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                    <i class="lni lni-users fs-4"></i>
                </div>
                <div>
                    <h6 class="mb-0">Usuarios</h6>
                    <p class="text-sm text-muted mb-0">@Model.TotalUsuarios registrados</p>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-light border-0"><i class="lni lni-search-alt"></i></span>
                <input type="text" name="busqueda" class="form-control bg-light border-0" 
                       placeholder="Buscar por nombre o correo..." 
                       value="@Model.Busqueda" 
                       id="busquedaInput" />
            </div>
        </div>

        <!-- Actions -->
        <div class="col-md-5 text-end">
            <div class="d-flex justify-content-end align-items-center gap-2">
                <a href="@Url.Action("LimpiarFiltros", "Admin")" class="main-btn dark-btn-outline btn-hover rounded-full px-4" title="Limpiar Filtros">
                    <i class="lni lni-reload me-2"></i> Limpiar
                </a>
                <button type="button" class="main-btn primary-btn btn-hover rounded-full px-4" onclick="abrirModalUsuario('crear')">
                    <i class="lni lni-plus me-2"></i> Nuevo Usuario
                </button>
            </div>
        </div>

        <!-- Checkbox for inactive -->
        <div class="col-12 mt-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="mostrarInactivos" value="true" 
                       id="mostrarInactivosCheck" 
                       @(ViewBag.MostrarInactivos == true ? "checked" : "") 
                       onchange="document.getElementById('filtrosForm').submit();">
                <label class="form-check-label text-sm text-muted" for="mostrarInactivosCheck">
                    Mostrar usuarios inactivos
                </label>
            </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" name="pagina" value="1" />
        <input type="hidden" name="cantidadPorPagina" value="10" />
    </form>
</div>

<!-- Mensajes de alerta -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No se encontraron usuarios</strong> que coincidan con los criterios de búsqueda.
        <a href="@Url.Action("LimpiarFiltros")" class="alert-link ms-2">Mostrar todos los usuarios</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Usuarios != null && !Model.Usuarios.Any() && string.IsNullOrEmpty(Model.Busqueda) && !Model.RolFiltro.HasValue)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No hay usuarios registrados en el sistema.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Grilla de Usuarios -->
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
    @if (Model.Usuarios != null && Model.Usuarios.Any())
    {
        foreach (var usuario in Model.Usuarios)
        {
            <div class="col">
                <div class="user-card position-relative">
                    @if (usuario.Estado != true)
                    {
                        <div class="position-absolute top-0 end-0 p-2">
                            <span class="badge bg-danger shadow-sm"><i class="lni lni-ban me-1"></i> Inactivo</span>
                        </div>
                    }
                    
                    <div class="user-card-body">
                        <div class="user-avatar-lg @(usuario.Rol?.ToLower() == "administrador" ? "bg-primary" : "bg-info") shadow-sm" style="opacity: 0.9;">
                            @(string.IsNullOrEmpty(usuario.Nombre) ? "?" : usuario.Nombre.Substring(0,1).ToUpper())
                        </div>
                        <h5 class="user-name" title="@usuario.Nombre">@usuario.Nombre</h5>
                        <p class="user-email text-muted mb-3"><a href="mailto:@usuario.Correo" class="text-decoration-none text-muted">@usuario.Correo</a></p>
                        <span class="badge @(usuario.Rol?.ToLower() == "administrador" ? "bg-primary bg-opacity-10 text-primary" : "bg-info bg-opacity-10 text-info") rounded-pill px-3 py-2 border-0" style="font-size: 0.85rem;">
                            <i class="@(usuario.Rol?.ToLower() == "administrador" ? "lni lni-shield" : "lni lni-user") me-1"></i> @usuario.Rol
                        </span>
                    </div>
                    
                    <div class="user-card-footer">
                        <button class="btn btn-sm btn-light text-primary rounded-circle shadow-sm" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: white;" onclick="abrirModalUsuario('ver', @usuario.Id_Usr)" title="Ver">
                            <i class="lni lni-eye fs-6"></i>
                        </button>
                        <button class="btn btn-sm btn-light text-warning rounded-circle shadow-sm" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: white;" onclick="abrirModalUsuario('editar', @usuario.Id_Usr)" title="Editar">
                            <i class="lni lni-pencil fs-6"></i>
                        </button>
                        
                        @if (usuario.Estado == true)
                        {
                            <button class="btn btn-sm btn-light text-danger rounded-circle shadow-sm" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: white;" onclick="confirmarEliminacionUsuario(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')" title="Eliminar">
                                <i class="lni lni-trash-can fs-6"></i>
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-light text-success rounded-circle shadow-sm" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: white;" onclick="confirmarReactivacionUsuario(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')" title="Reactivar">
                                <i class="lni lni-checkmark-circle fs-6"></i>
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

<div id="modalContainer"></div>

<!-- Paginación -->
@if (Model.TotalPaginas > 1 && Model.Usuarios != null && Model.Usuarios.Any())
{
    <div class="pagination-wrapper mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PaginaActual == 1 ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual - 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro,
                           mostrarInactivos = ViewBag.MostrarInactivos
                       })">
                        <i class="lni lni-chevron-left"></i>
                    </a>
                </li>

                @for (int i = 1; i <= Model.TotalPaginas; i++)
                {
                    <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("IndexUsuarios", "Admin", new { 
                               pagina = i, 
                               cantidadPorPagina = 10,
                               busqueda = Model.Busqueda,
                               rolFiltro = Model.RolFiltro,
                               mostrarInactivos = ViewBag.MostrarInactivos
                           })">@i</a>
                    </li>
                }

                <li class="page-item @(Model.PaginaActual == Model.TotalPaginas ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual + 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro,
                           mostrarInactivos = ViewBag.MostrarInactivos
                       })">
                        <i class="lni lni-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="pagination-info text-center mt-2">
            @{
                var inicio = (Model.PaginaActual - 1) * 10 + 1;
                var fin = Math.Min(Model.PaginaActual * 10, Model.TotalUsuarios);
            }
            <p class="text-sm text-muted">Mostrando @inicio-@fin de @Model.TotalUsuarios registros</p>
        </div>
    </div>
}

<script>
    // ========== FUNCIONALIDAD PARA USUARIOS ==========
    // (Scripts específicos de usuarios si los hay, aunque la mayoría están en Index o Modales)
    
     function abrirModalUsuario(accion, usuarioId = null) {
        console.log('Abriendo modal usuario:', accion, 'Usuario ID:', usuarioId);

        let url = '';
        const params = new URLSearchParams();

        // Agregar parámetros básicos
        params.append('accion', accion);

        if (usuarioId) {
            params.append('usuarioId', usuarioId);
        }

        // Mantener filtros
        const busqueda = '@Html.Raw(Model.Busqueda ?? "")';
        const rolFiltro = '@(Model.RolFiltro?.ToString() ?? "")';
        const pagina = '@Model.PaginaActual';
        const mostrarInactivos = '@(ViewBag.MostrarInactivos == true ? "true" : "false")';

        if (busqueda) params.append('busqueda', busqueda);
        if (rolFiltro) params.append('rolFiltro', rolFiltro);
        if (pagina) params.append('pagina', pagina);
        if (mostrarInactivos === 'true') params.append('mostrarInactivos', mostrarInactivos);

        url = '@Url.Action("ObtenerModalUsuario", "Admin")' + '?' + params.toString();
        console.log('URL del modal:', url);

        // Cargar modal via AJAX
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Error al cargar el modal: ' + response.status);
                return response.text();
            })
            .then(data => {
                document.getElementById('modalContainer').innerHTML = data;
                const modalElement = document.getElementById('usuarioModal');
        
                if (!modalElement) {
                    console.error('Modal element no encontrado después de cargar');
                    return;
                }
        
                const modal = new bootstrap.Modal(modalElement);
        
                // Configurar el evento cuando el modal se muestra completamente
                modalElement.addEventListener('shown.bs.modal', function () {
                    console.log('Modal mostrado, configurando submit para:', accion);
                    configurarSubmitForm(accion);
                });
        
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar el formulario: ' + error.message);
            });
    }

    function configurarSubmitForm(accion) {
        const form = document.getElementById('usuarioForm');

        if (!form) {
            console.error('Formulario no encontrado en configurarSubmitForm');
            return;
        }

        console.log('Configurando submit para acción:', accion, 'Form:', form);

        // Remover event listeners previos para evitar duplicados
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log('Submit del formulario para acción:', accion);

            // Limpiar errores previos
            limpiarErrores();

            // Validación manual del frontend (si es necesaria)
            let isValid = true;
            
            // Validación de contraseña solo al crear o si se intenta cambiar
            const passwordInput = document.getElementById('Password');
            if (accion === 'crear' && passwordInput && !passwordInput.value) {
                // Si es required, el navegador ya lo valida, pero podemos forzar
            }

            if (!isValid) {
                console.log('Validación frontend fallida');
                return false;
            }

            // Crear FormData directamente desde el formulario
            const formData = new FormData(newForm);
            // Asegurar que el controlador sepa que es una petición AJAX
            formData.append('isAjax', 'true');

            // Enviar la solicitud
            const url = '@Url.Action("GuardarUsuario", "Admin")';
            console.log('Enviando a:', url);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                return response.text().then(text => {
                    try {
                        const jsonData = JSON.parse(text);
                        return jsonData;
                    } catch (e) {
                         // Manejo de errores de parsing o respuesta HTML por error
                        if (response.status === 400) {
                            return {
                                success: false,
                                message: 'Error de validación en el servidor',
                                errors: ['Por favor verifique que todos los campos sean correctos'],
                                fieldErrors: {}
                            };
                        }
                        if (!response.ok) {
                            return {
                                success: false,
                                message: `Error del servidor: ${response.status}`,
                                errors: [text.substring(0, 200)], // Mostrar parte del error
                                fieldErrors: {}
                            };
                        }
                         return {
                            success: false,
                            message: 'Respuesta inesperada del servidor (posiblemente HTML)',
                            errors: [text.substring(0, 100) + '...'],
                            fieldErrors: {}
                        };
                    }
                });
            })
            .then(result => {
                if (!result) return;

                if (result.success) {
                    mostrarMensajeExito(result.message);
            
                    // Cerrar modal y recargar
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('usuarioModal'));
                        if (modal) modal.hide();
                        window.location.reload();
                    }, 1500);
                } else {
                    if (result.errors || result.fieldErrors) {
                        mostrarErroresEnFormulario(result.errors || [], result.fieldErrors || null);
                         // Asegurar que el modal siga visible y el overlay también
                        const modalElement = document.getElementById('usuarioModal');
                        if (modalElement) {
                             // Pequeño truco para forzar el re-renderizado si algo visual falló
                             modalElement.style.display = 'block';
                        }
                    } else {
                        mostrarErrorGeneral(result.message || 'Error desconocido');
                    }
                }
            })
            .catch(err => {
                console.error('Error en fetch:', err);
                mostrarErrorGeneral('Error de conexión: ' + err.message);
            });
        });
    }

    function confirmarEliminacionUsuario(usuarioId, nombreUsuario) {
        Swal.fire({
            title: 'Eliminar Usuario',
            html: `¿Está seguro que desea eliminar al usuario <strong>${nombreUsuario}</strong>?<br><small class="text-danger">Esta acción no se puede deshacer.</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Mostrar loading
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Eliminando usuario',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                window.location.href = '@Url.Action("EliminarUsuario", "Admin")'
                    + `?id=${usuarioId}&busqueda=@Model.Busqueda&rolFiltro=@Model.RolFiltro&pagina=@Model.PaginaActual&mostrarInactivos=@ViewBag.MostrarInactivos`;
            }
        });
    }

    function confirmarReactivacionUsuario(usuarioId, nombreUsuario) {
        Swal.fire({
            title: 'Reactivar Usuario',
            html: `¿Desea reactivar al usuario <strong>${nombreUsuario}</strong>?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#365CF5',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, reactivar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Mostrar loading
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Reactivando usuario',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                window.location.href = '@Url.Action("ReactivarUsuario", "Admin")'
                    + `?id=${usuarioId}&busqueda=@Model.Busqueda&rolFiltro=@Model.RolFiltro&pagina=@Model.PaginaActual&mostrarInactivos=@ViewBag.MostrarInactivos`;
            }
        });
    }

    // Funciones globales (se pueden mover a Index o Layout si se reutilizan mucho)
    // Se mantienen aquí por ahora para asegurar funcionalidad dentro del Partial renderizado
</script>
