@using VentaFacil.web.Models
@using VentaFacil.web.Models.Response.Planilla
@model NominaConsultaResponse
@{
    var cultureCR = new System.Globalization.CultureInfo("es-CR");
    var numberFormat = (System.Globalization.NumberFormatInfo)cultureCR.NumberFormat.Clone();
    numberFormat.CurrencySymbol = "¢";
}

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        --card-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    .premium-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 2rem;
        padding: 2rem 1.5rem 1.5rem 1.5rem;
    }
    .table-container {
        background: #fff;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .premium-table thead th {
        background-color: #f8fafc;
        color: #222 !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
    }
    .premium-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
    }
    .premium-table tbody tr:last-child td {
        border-bottom: none;
    }
    .premium-table tbody tr:hover {
        background-color: #f8fafc;
    }
    .badge-premium {
        border-radius: 30px;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.4em 1em;
    }
    .btn-premium {
        border-radius: 30px !important;
        font-weight: 600;
        padding: 0.5rem 1.5rem;
    }
    .pagination-premium .page-link {
        border-radius: 30px !important;
        margin: 0 2px;
    }
</style>

<section class="content-header mb-4">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h2 class="fw-bold text-dark">Consultar Nóminas</h2>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
                    <li class="breadcrumb-item active">Planilla</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-lg-3 col-6">
                <div class="premium-card text-center">
                    <div class="mb-2">
                        <i class="fas fa-file-invoice-dollar text-info fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-0">@(Model?.Nominas?.Count ?? 0)</h3>
                    <p class="text-muted mb-0">Nóminas Generadas</p>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="premium-card text-center">
                    <div class="mb-2">
                        <i class="fas fa-money-bill-wave text-success fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-0">@((Model?.Nominas?.Sum(x => x.TotalNeto) ?? 0).ToString("C", numberFormat))</h3>
                    <p class="text-muted mb-0">Total Pagado</p>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="premium-card text-center">
                    <div class="mb-2">
                        <i class="fas fa-chart-pie text-warning fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-0>@((Model?.Nominas?.Sum(x => x.TotalDeducciones) ?? 0).ToString("C", numberFormat))</h3>
                    <p class="text-muted mb-0">Total Deducciones</p>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="premium-card text-center">
                    <div class="mb-2">
                        <i class="fas fa-users-cog text-secondary fs-2"></i>
                    </div>
                    <h3 class="fw-bold mb-0">Planilla</h3>
                    <p class="text-muted mb-0">Módulo General</p>
                </div>
            </div>
        </div>

        <div class="premium-card mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">Acciones de Planilla</h4>
            </div>
            <div class="row">
                <div class="col-md-12 mb-2">
                    <a href="@Url.Action("GenerarNomina", "Planilla")" class="btn btn-success btn-premium me-2">
                        <i class="fas fa-plus-circle"></i> Generar Nómina
                    </a>
                    <a href="@Url.Action("RegistrarHoras", "Planilla")" class="btn btn-primary btn-premium me-2">
                        <i class="fas fa-clock"></i> Registrar Horas
                    </a>
                    <a href="@Url.Action("RegistrarExtrasBonos", "Planilla")"
                       class="btn btn-warning btn-premium me-2 text-white">
                        <i class="fas fa-star"></i> Extras/Bonos
                    </a>
                    <a href="@Url.Action("AplicarDeducciones", "Planilla")" class="btn btn-danger btn-premium me-2">
                        <i class="fas fa-cut"></i> Deducciones
                    </a>
                </div>
                <div class="col-md-12 mt-2">
                    <form method="get" action="@Url.Action("Consultar", "Planilla")" class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <label class="form-label mb-0">Periodo:</label>
                            <select name="TipoPeriodo" class="form-select form-select-sm rounded-pill">
                                <option value="">-- Todos --</option>
                                <option value="Mensual" selected="@(ViewBag.Filtros?.TipoPeriodo == "Mensual")">Mensual (Este Mes)</option>
                                <option value="Trimestral" selected="@(ViewBag.Filtros?.TipoPeriodo == "Trimestral")">Trimestral (Últimos 3)</option>
                                <option value="Anual" selected="@(ViewBag.Filtros?.TipoPeriodo == "Anual")">Anual (Este Año)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-0">Usuario:</label>
                            <select name="Id_Usr" class="form-select form-select-sm rounded-pill" asp-items="ViewBag.Usuarios">
                                <option value="">-- Todos --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-0">Estado:</label>
                            <select name="Estado" class="form-select form-select-sm rounded-pill">
                                <option value="">-- Todos --</option>
                                <option value="Generada" selected="@(ViewBag.Filtros?.Estado == "Generada")">Generada</option>
                                <option value="Anulada" selected="@(ViewBag.Filtros?.Estado == "Anulada")">Anulada</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-info btn-premium me-2">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <a href="@Url.Action("Consultar", "Planilla")" class="btn btn-light btn-premium">Limpiar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">Listado de Nóminas</h4>
                <div>
                    <a href="#" class="btn btn-light btn-premium me-2"><i class="fas fa-download"></i></a>
                    <a href="#" class="btn btn-light btn-premium"><i class="fas fa-bars"></i></a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table premium-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Colaboradores</th>
                            <th>Periodo Inicio</th>
                            <th>Periodo Final</th>
                            <th>Fecha Generación</th>
                            <th>Estado</th>
                            <th>Total Bruto</th>
                            <th>Deducciones</th>
                            <th>Total Neto</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Nominas != null && Model.Nominas.Any())
                        {
                            foreach (var item in Model.Nominas)
                            {
                                <tr>
                                    <td>@item.Id_Nomina</td>
                                    <td>
                                        @if(item.Planillas != null && item.Planillas.Any())
                                        {
                                            var nombres = item.Planillas
                                                .Where(p => p.Usuario != null)
                                                .GroupBy(p => p.Usuario.Id_Usr)
                                                .Select(g => g.First().Usuario.Nombre.Trim())
                                                .Take(3)
                                                .ToList();
                                            var total = item.Planillas.Select(p => p.Usuario?.Id_Usr).Distinct().Count();
                                            
                                            @string.Join(", ", nombres)
                                            @(total > 3 ? $" y {total - 3} más..." : "")
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>@item.FechaInicio.ToString("dd/MM/yyyy")</td>
                                    <td>@item.FechaFinal.ToString("dd/MM/yyyy")</td>
                                    <td>@item.FechaGeneracion.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        @if (item.Estado == "Generada")
                                        {
                                            <span class="badge badge-premium bg-success bg-opacity-10 text-success border border-success border-opacity-25">Generada</span>
                                        }
                                        else if (item.Estado == "Anulada")
                                        {
                                            <span class="badge badge-premium bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">Anulada</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-premium bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">@item.Estado</span>
                                        }
                                    </td>
                                    <td class="text-secondary">@item.TotalBruto.ToString("C", numberFormat)</td>
                                    <td class="text-danger">@item.TotalDeducciones.ToString("C", numberFormat)</td>
                                    <td class="fw-bold text-success">@item.TotalNeto.ToString("C", numberFormat)</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-2">
                                            <a href="#" class="btn btn-info btn-premium btn-sm disabled" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("ExportarNomina", "Planilla", new { idNomina = item.Id_Nomina })" class="btn btn-secondary btn-premium btn-sm" title="Descargar PDF" target="_blank">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                            @if (item.Estado != "Anulada")
                                            {
                                                <form asp-action="RevertirNomina" method="post" style="display:inline;">
                                                    <input type="hidden" name="idNomina" value="@item.Id_Nomina" />
                                                    <button type="submit" class="btn btn-danger btn-premium btn-sm" title="Anular" onclick="return confirm('¿Está seguro de anular esta nómina?');">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="10" class="text-center text-muted py-3">
                                    <div class="empty-state">
                                        <i class="fas fa-folder-open mb-2" style="font-size: 2em;"></i>
                                        <p class="m-0">No se encontraron nóminas registradas.</p>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                @if (Model != null && Model.TotalPaginas > 1)
                {
                    <ul class="pagination pagination-premium justify-content-end">
                        <li class="page-item @(Model.PaginaActual == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Consultar", new { pagina = Model.PaginaActual - 1 })">&laquo;</a>
                        </li>
                        @for (int i = 1; i <= Model.TotalPaginas; i++)
                        {
                            <li class="page-item @(Model.PaginaActual == i ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Consultar", new { pagina = i })">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.PaginaActual == Model.TotalPaginas ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Consultar", new { pagina = Model.PaginaActual + 1 })">&raquo;</a>
                        </li>
                    </ul>
                }
            </div>
        </div>
    </div>
</section>