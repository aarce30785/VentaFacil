@using VentaFacil.web.Models.Response.Admin
@using VentaFacil.web.Models.Dto
@using VentaFacil.web.Models.Response.Producto
@model UsuarioListResponse
@{
    ViewData["Title"] = "Panel de administrador";
    Layout = "_LayoutPlantilla";
    var productosResponse = ViewData["Productos"] as ListProductoResponse ?? new ListProductoResponse();
}

<!-- ========== table components start ========== -->
<section class="table-components">
    <div class="container-fluid">
        <!-- ========== title-wrapper start ========== -->
        <div class="title-wrapper pt-30">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2>Panel de Administrador</h2>
                    </div>
                </div>
                <!-- end col -->
                <div class="col-md-6">
                    <div class="breadcrumb-wrapper">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#0">Dashboard</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Gestión
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <!-- end col -->
            </div>
            <!-- end row -->
        </div>
        <!-- ========== title-wrapper end ========== -->
        <!-- ========== tabs section start ========== -->
        <div class="tables-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card-style mb-30">
                        <!-- Tabs Navigation -->
                        <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                                    <i class="lni lni-users me-2"></i>Usuarios
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="products-tab" data-bs-toggle="pill" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Productos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="categoria-tab" data-bs-toggle="pill" data-bs-target="#categoria" type="button" role="tab" aria-controls="categoria" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Categoria
                                </button>
                            </li>
                        </ul>

                        <!-- Tabs Content -->
                        <div class="tab-content" id="adminTabsContent">

                            <!-- Tab de Usuarios -->
                            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                                <partial name="_GestionUsuarios" model="Model" />
                            </div>

                            <!-- Tab de Productos -->
                            <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                                <partial name="_GestionProductos" model="productosResponse" />
                            </div>

                            <!-- Tab de Categorías (placeholder) -->
                            <div class="tab-pane fade" id="categoria" role="tabpanel" aria-labelledby="categoria-tab">
                                <div class="text-center py-5">
                                    <i class="lni lni-package text-muted" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3 text-muted">Gestión de Categorías</h4>
                                    <p class="text-muted">Esta funcionalidad estará disponible próximamente.</p>
                                </div>
                            </div>
                        </div>
                        </div>

                        </div> <!-- end card -->
                </div> <!-- end col -->
            </div> <!-- end row -->
        </div> <!-- ========== tabs section end ========== -->
    </div> <!-- end container -->
</section>

@section Scripts {
    <script>
        // Funciones auxiliares globales para mensajes y errores
        function limpiarErrores() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            const alert = document.querySelector('.alert-danger');
            if (alert) alert.remove();
        }

        function mostrarError(campoId, mensaje) {
            const input = document.getElementById(campoId);
            if (input) {
                input.classList.add('is-invalid');
                const errorSpan = document.querySelector(`span[data-valmsg-for="${campoId}"]`) || 
                                  document.querySelector(`span[data-valmsg-for="${campoId}"]`) ||
                                  input.nextElementSibling;
                if (errorSpan) errorSpan.textContent = mensaje;
            }
        }

        function mostrarErrorGeneral(mensaje) {
            const form = document.querySelector('.modal.show form');
            if (form) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="lni lni-warning me-2"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                form.insertBefore(alertDiv, form.firstChild);
            } else {
                alert(mensaje);
            }
        }

        function mostrarMensajeExito(mensaje) {
            const form = document.querySelector('.modal.show form');
            if (form) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="lni lni-checkmark-circle me-2"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                form.insertBefore(alertDiv, form.firstChild);
            }
        }

        function mostrarErroresEnFormulario(errors, fieldErrors) {
            if (errors && errors.length > 0) {
                mostrarErrorGeneral(errors.join('<br>'));
            }

            if (fieldErrors) {
                for (const [key, value] of Object.entries(fieldErrors)) {
                    // Intentar encontrar el campo por ID o nombre
                    const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        // Buscar el span de validación
                        let errorSpan = document.querySelector(`span[data-valmsg-for="${key}"]`);
                        if (!errorSpan) {
                            // Si no existe, buscar el siguiente elemento con clase text-danger
                            errorSpan = input.parentNode.querySelector('.text-danger');
                        }
                        
                        if (errorSpan) {
                            errorSpan.textContent = Array.isArray(value) ? value[0] : value;
                        }
                    }
                }
            }
        }
    </script>
}
