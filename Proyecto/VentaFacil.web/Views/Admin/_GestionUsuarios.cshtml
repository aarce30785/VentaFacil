@model VentaFacil.web.Models.Response.Admin.UsuarioListResponse



<!-- Controles de Búsqueda y Filtros -->
<form method="get" asp-action="IndexUsuarios" class="row g-3" id="filtrosForm">

    <div class="row mt-3">
        <div class="col">
            <div class="input-group rounded-pill shadow-sm overflow-hidden">
                <input type="text" name="busqueda" class="form-control border-0 ps-4" 
                       placeholder="Buscar por nombre o correo..." 
                       value="@Model.Busqueda" 
                       id="busquedaInput" 
                       style="height: 56.5px;" />
                <button type="submit" class="btn btn-primary rounded-pill px-4 border-0" 
                        style="margin: 3px; height: 50px;">
                    <i class="lni lni-search-alt"></i> Buscar
                </button>
            </div>
        </div>

        <div class="col-md-auto">
            <a href="@Url.Action("LimpiarFiltros", "Admin")" class="main-btn dark-btn rounded-full btn-hover">
                <i class="lni lni-close"></i> Limpiar
            </a>
        </div>

        <div class="col-md-auto">
            <button type="button" class="main-btn secondary-btn rounded-full btn-hover" onclick="abrirModalUsuario('crear')">
                <i class="lni lni-plus text-black"></i> Agregar Usuario
            </button>
        </div>
    </div>


    <div class="row mb-3 mt-3">


        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="mostrarInactivos" value="true" 
                       id="mostrarInactivosCheck" 
                       @(ViewBag.MostrarInactivos == true ? "checked" : "") 
                       onchange="document.getElementById('filtrosForm').submit();">
                <label class="form-check-label" for="mostrarInactivosCheck">
                    Mostrar usuarios inactivos
                </label>
            </div>
        </div>
    </div>

    <!-- Campos ocultos para mantener otros parámetros -->
    <input type="hidden" name="pagina" value="1" />
    <input type="hidden" name="cantidadPorPagina" value="10" />
</form>

<!-- Mensajes de alerta (sin cambios) -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No se encontraron usuarios</strong> que coincidan con los criterios de búsqueda.
        <a href="@Url.Action("LimpiarFiltros")" class="alert-link ms-2">Mostrar todos los usuarios</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Usuarios != null && !Model.Usuarios.Any() && string.IsNullOrEmpty(Model.Busqueda) && !Model.RolFiltro.HasValue)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No hay usuarios registrados en el sistema.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabla de Usuarios -->
<div class="table-wrapper table-responsive">
    <table class="table premium-table">
        <thead>
            <tr>
                <th class="lead-name"><h6>Nombre</h6></th>
                <th class="lead-email"><h6>Email</h6></th>
                <th class="lead-role"><h6>Rol</h6></th>
                <th><h6>Acción</h6></th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Usuarios != null && Model.Usuarios.Any())
            {
                foreach (var usuario in Model.Usuarios)
                {
                    <tr>
                        <td class="min-width">
                           
                            <div class="lead">
                                <div class="lead-text">
                                    <p>@usuario.Nombre</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            <div class="lead">
                                
                                <div class="lead-text">
                                    <p>@usuario.Correo</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            @if (usuario.Estado == true)
                            {
                                @usuario.Rol
                            }
                            else
                            {
                                <span>Inactivo</span>
                            }
                        </td>
                        <td>
                            <div class="action d-flex gap-2">
                                @if (usuario.Estado == true)
                                {
                                    <!-- Editar -->
                                    <a href="javascript:void(0);" 
                                       onclick="abrirModalUsuario('editar', @usuario.Id_Usr)"
                                       class="text-warning" title="Editar">
                                        <i class="lni lni-pencil"></i>
                                    </a>

                                    <!-- Eliminar -->
                                    <a class="text-danger" href="javascript:void(0);"
                                       onclick="confirmarEliminacion(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')"
                                       title="Eliminar">
                                        <i class="lni lni-trash-can"></i>
                                    </a>
                                }
                                else
                                {
                                    <!-- Reactivar -->
                                    <a class="text-success" href="javascript:void(0);"
                                       title="Reactivar Usuario" 
                                       onclick="confirmarReactivacion(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')">
                                        <i class="lni lni-reload"></i>
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="text-muted">
                            <i class="lni lni-users me-2"></i>
                            @if (Model.Usuarios == null)
                            {
                                <span>Error al cargar los usuarios</span>
                            }
                            else if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                            {
                                <span>No se encontraron usuarios con los filtros aplicados</span>
                            }
                            else
                            {
                                <span>No hay usuarios registrados</span>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Paginación (sin cambios) -->
@if (Model.TotalPaginas > 1 && Model.Usuarios != null && Model.Usuarios.Any())
{
    <div class="pagination-wrapper mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PaginaActual == 1 ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual - 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })">
                        <i class="lni lni-chevron-left"></i>
                    </a>
                </li>

                @for (int i = 1; i <= Model.TotalPaginas; i++)
                {
                    <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("IndexUsuarios", "Admin", new { 
                               pagina = i, 
                               cantidadPorPagina = 10,
                               busqueda = Model.Busqueda,
                               rolFiltro = Model.RolFiltro
                           })">@i</a>
                    </li>
                }

                <li class="page-item @(Model.PaginaActual == Model.TotalPaginas ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual + 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })">
                        <i class="lni lni-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="pagination-info text-center mt-2">
            @{
                var inicio = (Model.PaginaActual - 1) * 10 + 1;
                var fin = Math.Min(Model.PaginaActual * 10, Model.TotalUsuarios);
            }
            <p class="text-sm text-muted">
                Mostrando @inicio-@fin de @Model.TotalUsuarios registros
                @if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                {
                    <span class="ms-2">
                        <a href="@Url.Action("LimpiarFiltros")" class="text-primary text-decoration-underline">
                            (Ver todos)
                        </a>
                    </span>
                }
            </p>
        </div>
    </div>
}

<!-- Script unificado - CORREGIDO -->


<!-- Modals para Confirmaciones (SweetAlert2 usado directamente) -->
<!-- <div class="modal fade" id="confirmarGuardarModal" ... (Removed) -->

<div id="modalContainerUsuarios"></div>

<!-- Script unificado - CORREGIDO -->
<script>
    (function() {
        'use strict';

        // Variables para el modal de reactivación
        let reactivarModalInstance = null;
        let usuarioAReactivar = {
            id: null,
            nombre: ''
        };

        // Variables para el modal de eliminación
        let eliminarModalInstance = null;
        let usuarioAEliminar = {
            id: null,
            nombre: ''
        };

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            inicializarFiltros();
        });

        // ===== FUNCIONES DE FILTROS =====
        function inicializarFiltros() {
            // Filtro de roles - usando el ID correcto
            const rolFilter = document.getElementById('rolFiltroSelect');
            if (rolFilter) {
                rolFilter.addEventListener('change', function() {
                    document.getElementById('filtrosForm').submit();
                });
            }

            // Búsqueda con Enter
            const busquedaInput = document.getElementById('busquedaInput');
            if (busquedaInput) {
                busquedaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('filtrosForm').submit();
                    }
                });
            }
        }

        // Variables para el control de cambios
        let initialFormValues = {};

        // ===== FUNCIONES DEL MODAL DE USUARIO (NUEVO) =====
        window.abrirModalUsuario = function(accion, usuarioId = null) {
            console.log('Abriendo modal usuario:', accion, 'Usuario ID:', usuarioId);

            let url = '';
            const params = new URLSearchParams();
            params.append('accion', accion);
            if (usuarioId) params.append('usuarioId', usuarioId);

            // Mantener filtros
            const busqueda = '@Html.Raw(Model.Busqueda ?? "")';
            const rolFiltro = '@(Model.RolFiltro?.ToString() ?? "")';
            const pagina = '@Model.PaginaActual';

            if (busqueda) params.append('busqueda', busqueda);
            if (rolFiltro) params.append('rolFiltro', rolFiltro);
            if (pagina) params.append('pagina', pagina);

            url = '@Url.Action("ObtenerModalUsuario", "Admin")' + '?' + params.toString();

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar el modal: ' + response.status);
                    return response.text();
                })
                .then(data => {
                    document.getElementById('modalContainerUsuarios').innerHTML = data;
                    const modalElement = document.getElementById('usuarioModal');
            
                    if (!modalElement) {
                        console.error('Modal element no encontrado');
                        return;
                    }
            
                    const modal = new bootstrap.Modal(modalElement);
                    modalElement.addEventListener('shown.bs.modal', function () {
                        // Capturar valores iniciales una vez que el modal se muestra
                        capturarValoresIniciales();
                        configurarSubmitFormUsuario(accion);
                    });
            
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el formulario: ' + error.message);
                });
        };

        function capturarValoresIniciales() {
            const form = document.getElementById('usuarioForm');
            if (!form) return;

            initialFormValues = {
                Nombre: form.querySelector('[name="Nombre"]')?.value || '',
                Correo: form.querySelector('[name="Correo"]')?.value || '',
                Rol: form.querySelector('[name="Rol"]')?.value || '',
                Estado: form.querySelector('[name="Estado"]')?.checked || false
            };
            // Contraseña no se captura porque siempre inicia vacía o enmascarada
        }

        function obtenerCambios(form, accion) {
            const cambios = [];
            const currentValues = {
                Nombre: form.querySelector('[name="Nombre"]')?.value || '',
                Correo: form.querySelector('[name="Correo"]')?.value || '',
                Rol: form.querySelector('[name="Rol"]')?.value || '',
                Estado: form.querySelector('[name="Estado"]')?.checked || false,
                Contrasena: form.querySelector('[name="Contrasena"]')?.value || ''
            };

            // Solo comparar si es edición, si es crear mostramos resumen general
            if (accion === 'editar') {
                if (currentValues.Nombre !== initialFormValues.Nombre) {
                    cambios.push(`<strong>Nombre:</strong> ${initialFormValues.Nombre} <i class="lni lni-arrow-right"></i> ${currentValues.Nombre}`);
                }
                if (currentValues.Correo !== initialFormValues.Correo) {
                    cambios.push(`<strong>Correo:</strong> ${initialFormValues.Correo} <i class="lni lni-arrow-right"></i> ${currentValues.Correo}`);
                }
                if (currentValues.Rol !== initialFormValues.Rol) {
                    // Intentar obtener texto del rol seleccionado
                    const select = form.querySelector('[name="Rol"]');
                    const oldText = select.querySelector(`option[value="${initialFormValues.Rol}"]`)?.text || initialFormValues.Rol;
                    const newText = select.options[select.selectedIndex]?.text || currentValues.Rol;
                    cambios.push(`<strong>Rol:</strong> ${oldText} <i class="lni lni-arrow-right"></i> ${newText}`);
                }
                if (currentValues.Estado !== initialFormValues.Estado) {
                    const oldState = initialFormValues.Estado ? 'Activo' : 'Inactivo';
                    const newState = currentValues.Estado ? 'Activo' : 'Inactivo';
                    cambios.push(`<strong>Estado:</strong> ${oldState} <i class="lni lni-arrow-right"></i> ${newState}`);
                }
                if (currentValues.Contrasena) {
                    cambios.push(`<strong>Contraseña:</strong> <em>(Se ha modificado)</em>`);
                }
            } else {
                // Modo crear: listar los valores ingresados
                cambios.push(`<strong>Nombre:</strong> ${currentValues.Nombre}`);
                cambios.push(`<strong>Correo:</strong> ${currentValues.Correo}`);
                const select = form.querySelector('[name="Rol"]');
                const rolText = select.options[select.selectedIndex]?.text || currentValues.Rol;
                cambios.push(`<strong>Rol:</strong> ${rolText}`);
                cambios.push(`<strong>Estado:</strong> Inactivo (Pendiente de activación)`);
                cambios.push(`<strong>Nota:</strong> Se enviará un correo de activación.`);
            }

            return cambios;
        }

        window.configurarSubmitFormUsuario = function(accion) {
            const form = document.getElementById('usuarioForm');
            if (!form) return;

            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);

            newForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Validación básica de HTML5
                if (!newForm.checkValidity()) {
                    newForm.classList.add('was-validated');
                    return;
                }

                // Detectar cambios
                const listaCambios = obtenerCambios(newForm, accion);
                const modalBody = document.querySelector('#confirmarGuardarModal .modal-body');
                
                if (listaCambios.length === 0) {
                     modalBody.innerHTML = '<div class="alert alert-warning">No se han detectado cambios.</div>';
                } else {
                    let html = accion === 'crear' 
                        ? '<p>Se creará un nuevo usuario con los siguientes datos:</p>' 
                        : '<p>Se realizarán las siguientes modificaciones:</p>';
                    
                    html += '<ul class="list-group list-group-flush">';
                    listaCambios.forEach(cambio => {
                        html += `<li class="list-group-item">${cambio}</li>`;
                    });
                    html += '</ul>';
                    modalBody.innerHTML = html;
                }

                // Mostrar modal de confirmación
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmarGuardarModal'));
                const btnConfirmar = document.getElementById('btnConfirmarGuardar');
                
                // Si no hay cambios en edición, deshabilitar guardar o permitir "guardar sin cambios"
                // Permitiremos guardar de todos modos por consistencia, o el usuario puede cancelar.
                
                // Configurar acción del botón confirmar
                btnConfirmar.onclick = function() {
                    confirmModal.hide();
                    enviarFormularioUsuario(newForm);
                };

                confirmModal.show();
            });
        };

        function enviarFormularioUsuario(form) {
            const formData = new FormData(form);
            formData.append('isAjax', 'true'); // Flag para el backend

            // Mostrar estado de carga en el botón del formulario
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                   // Si el servidor devuelve error (400, 500), intentamos parsear JSON
                   return response.json().then(errData => { throw new Error(errData.message || 'Error en el servidor'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Cerrar modal de usuario
                    const modalElement = document.getElementById('usuarioModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();

                    // Mostrar mensaje de éxito y recargar
                    window.location.reload(); 
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        }




        // ===== FUNCIONES DEL MODAL DE REACTIVACIÓN =====
        // (No initialization needed for SweetAlert2)

        // ===== FUNCIONES DEL MODAL DE ELIMINACIÓN =====
        // (No initialization needed for SweetAlert2)

        // Función global para confirmar reactivación
        window.confirmarReactivacion = function(usuarioId, nombreUsuario) {
            Swal.fire({
                title: 'Confirmar Reactivación',
                text: `¿Está seguro de que desea reactivar al usuario "${nombreUsuario}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#365CF5', // Primary
                cancelButtonColor: '#secondary',
                confirmButtonText: 'Sí, reactivar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    reactivarUsuario(usuarioId);
                }
            });
        };

        // Función global para confirmar eliminación
        window.confirmarEliminacion = function(usuarioId, nombreUsuario) {
            Swal.fire({
                title: 'Confirmar Eliminación',
                html: `¿Está seguro de que desea eliminar al usuario <strong>${nombreUsuario}</strong>?<br/><small class="text-danger">Esta acción no se puede deshacer.</small>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // Danger
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    realizarEliminacion(usuarioId);
                }
            });
        };

        // Función para reactivar usuario
        function reactivarUsuario(usuarioId) {
            // Safely get properties from Razor
            var busqueda = @Json.Serialize(Model.Busqueda);
            var rolFiltro = @Json.Serialize(Model.RolFiltro);
            var mostrarInactivos = @Json.Serialize(ViewBag.MostrarInactivos);
            var pagina = @Json.Serialize(Model.PaginaActual);

            // Construir URL con los parámetros actuales
            var url = '@Url.Action("ReactivarUsuario", "Admin")' + 
                       '?id=' + usuarioId + 
                       '&busqueda=' + encodeURIComponent(busqueda || '') +
                       '&rolFiltro=' + (rolFiltro || '') +
                       '&mostrarInactivos=' + (mostrarInactivos === true) +
                       '&pagina=' + (pagina || 1);
            
            window.location.href = url;
        }

        // Función para realizar la eliminación
        function realizarEliminacion(usuarioId) {
            // Mostrar SweetAlert de carga (opcional, o dejar que navegue)
            // Mostrar SweetAlert de carga (opcional)
            Swal.fire({
                title: 'Eliminando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            // O mostrar Toastify de "Procesando..." si prefieres evitar el modal de carga intrusivo
            /*
            Toastify({
                text: "Procesando eliminación...",
                duration: 2000,
                gravity: "bottom",
                position: "right",
            }).showToast();
            */

            // Obtener parámetros para mantener el contexto
            var busqueda = @Json.Serialize(Model.Busqueda);
            var rolFiltro = @Json.Serialize(Model.RolFiltro);
            var pagina = @Json.Serialize(Model.PaginaActual);
            
            // Construir URL (EliminarUsuario es un GET que retorna un Redirect)
            var url = '@Url.Action("EliminarUsuario", "Admin")' + 
                       '?id=' + usuarioId + 
                       '&busqueda=' + encodeURIComponent(busqueda || '') +
                       '&rolFiltro=' + (rolFiltro || '') +
                       '&pagina=' + (pagina || 1);
            
            // Navegar directamente
            window.location.href = url;
        }
        
        // Modificación de configurarSubmitFormUsuario para usar SweetAlert en Confirmación
        window.configurarSubmitFormUsuario = function(accion) {
            const form = document.getElementById('usuarioForm');
            if (!form) return;

            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);

            newForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Validación básica de HTML5
                if (!newForm.checkValidity()) {
                    newForm.classList.add('was-validated');
                    return;
                }

                // Detectar cambios
                const listaCambios = obtenerCambios(newForm, accion);
                
                let html = '';
                if (listaCambios.length === 0) {
                     html = '<div class="alert alert-warning">No se han detectado cambios.</div>';
                } else {
                    html = accion === 'crear' 
                        ? '<p>Se creará un nuevo usuario con los siguientes datos:</p>' 
                        : '<p>Se realizarán las siguientes modificaciones:</p>';
                    
                    html += '<ul class="list-group list-group-flush text-start">';
                    listaCambios.forEach(cambio => {
                        html += `<li class="list-group-item">${cambio}</li>`;
                    });
                    html += '</ul>';
                }

                // Mostrar SweetAlert de confirmación
                // Mostrar SweetAlert de confirmación
                Swal.fire({
                    title: 'Confirmar Cambios',
                    html: html,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Guardar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#365CF5'
                }).then((result) => {
                    if (result.isConfirmed) {
                        enviarFormularioUsuario(newForm);
                    }
                });
            });
        };

        function enviarFormularioUsuario(form) {
            const formData = new FormData(form);
            formData.append('isAjax', 'true'); // Flag para el backend

            // Mostrar estado de carga con SweetAlert (Opcional, o usar Toastify loader)
            Swal.fire({
                title: 'Guardando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                   Swal.showLoading();
                }
            });

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                   return response.json().then(errData => { throw new Error(errData.message || 'Error en el servidor'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Cerrar modal de usuario
                    const modalElement = document.getElementById('usuarioModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                    
                    Swal.close(); // Cerrar loader

                    // Mostrar Toastify de éxito y recargar
                    Toastify({
                        text: "<strong>¡Éxito!</strong> " + (data.message || 'Operación realizada correctamente'),
                        duration: 3000,
                        gravity: "bottom",
                        position: "right",
                        escapeMarkup: false,
                        style: {
                            background: "linear-gradient(to right, #00b09b, #96c93d)",
                        }
                    }).showToast();

                    setTimeout(() => {
                        window.location.reload();
                    }, 1000); 
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.close();
                
                Toastify({
                    text: "<strong>Error:</strong> " + error.message,
                    duration: 5000,
                    gravity: "bottom",
                    position: "right",
                    escapeMarkup: false,
                    style: {
                         background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }
                }).showToast();
            });
        }

        // Función para enviar correo de restablecimiento de contraseña
        window.enviarCorreoRestablecer = function(usuarioId) {
             Swal.fire({
                title: 'Enviar correo de restablecimiento',
                text: "¿Desea enviar un correo al usuario para que restablezca su contraseña?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#365CF5',
                cancelButtonColor: '#secondary',
                confirmButtonText: 'Sí, enviar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarSolicitudRestablecimiento(usuarioId);
                }
            });
        };

        function enviarSolicitudRestablecimiento(usuarioId) {
            Swal.fire({
                title: 'Enviando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const url = '@Url.Action("EnviarRestablecerContrasena", "Admin")';
            const formData = new FormData();
            formData.append('id', usuarioId);

            // Intentar obtener el token del formulario del modal si existe, o buscar uno global
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenElement ? tokenElement.value : '';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                     'RequestVerificationToken': token,
                     'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                if (data.success) {
                    Toastify({
                        text: "<strong>¡Éxito!</strong> " + (data.message || 'Correo enviado correctamente'),
                        duration: 3000,
                        gravity: "bottom",
                        position: "right",
                        escapeMarkup: false,
                        style: {
                            background: "linear-gradient(to right, #00b09b, #96c93d)",
                        }
                    }).showToast();
                } else {
                    Toastify({
                        text: "<strong>Error:</strong> " + (data.message || 'No se pudo enviar el correo'),
                        duration: 5000,
                        gravity: "bottom",
                        position: "right",
                        escapeMarkup: false,
                        style: {
                             background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        }
                    }).showToast();
                }
            })
            .catch(error => {
                Swal.close();
                Toastify({
                    text: "<strong>Error:</strong> Ocurrió un error al procesar la solicitud",
                    duration: 5000,
                    gravity: "bottom",
                    position: "right",
                    escapeMarkup: false,
                    style: {
                         background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }
                }).showToast();
                console.error('Error:', error);
            });
        }

    })();
</script>
