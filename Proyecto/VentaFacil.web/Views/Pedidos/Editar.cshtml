@model VentaFacil.web.Models.Dto.PedidoDto
@using VentaFacil.web.Models.Enum
@using VentaFacil.web.Models.Enums

@{
    ViewData["Title"] = $"Editar Pedido #{Model.Id_Venta}";
    bool editable = Model.Estado == PedidoEstado.Borrador;
    // NUEVA VARIABLE PARA PE06
    bool puedeCancelar = Model.Estado == PedidoEstado.Borrador || Model.Estado == PedidoEstado.EnviadoACocina;
}

<div class="card shadow-sm p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">📋 Editar Pedido #@Model.Id_Venta</h4>
        <span class="badge @(Model.Estado == PedidoEstado.Borrador ? "bg-secondary" :
                                                               Model.Estado == PedidoEstado.EnviadoACocina ? "bg-warning text-dark" :
                                                               "bg-success")">
            Estado: @Model.Estado
        </span>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (!editable)
    {
        <div class="alert alert-warning mb-3">
            <strong>⚠️ Este pedido no se puede modificar</strong> porque ya no está en estado borrador (fue enviado a cocina o está en proceso).
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">👤 Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="ActualizarModalidad">
                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />

                        <div class="mb-3">
                            <label class="form-label fw-bold">Cliente</label>
                            <input type="text" class="form-control" name="cliente" value="@Model.Cliente"
                                   placeholder="Nombre del cliente" @(!editable ? "disabled" : "") />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Modalidad</label>
                            <select class="form-select" name="modalidad" @(!editable ? "disabled" : "")
                                    onchange="this.form.submit()">
                                <option value="0" selected="@(Model.Modalidad == ModalidadPedido.ParaLlevar)">📦 Para Llevar</option>
                                <option value="1" selected="@(Model.Modalidad == ModalidadPedido.EnMesa)">🍽️ En Mesa</option>
                            </select>
                        </div>

                        @if (Model.Modalidad == ModalidadPedido.EnMesa)
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">Número de Mesa</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="numeroMesa"
                                           value="@Model.NumeroMesa" min="1" @(!editable ? "disabled" : "") />
                                    <button type="submit" class="btn btn-primary" @(!editable ? "disabled" : "")>
                                        Actualizar
                                    </button>
                                </div>
                            </div>
                        }
                    </form>

                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-6">
                                <strong>Total:</strong>
                            </div>
                            <div class="col-6 text-end">
                                <span class="fw-bold text-primary">$@Model.Total.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (editable)
            {
                <div class="card">
                    <div class="card-body">
                        <form method="post" asp-action="GuardarPedido" class="mb-2">
                            <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                            <button type="submit" class="btn btn-success w-100">
                                ✅ Enviar a Cocina
                            </button>
                            <small class="text-muted">(Cambia el estado a @nameof(PedidoEstado.EnviadoACocina) y no podrá editarse)</small>
                        </form>

                        <form method="post" asp-action="GuardarBorrador">
                            <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                            <button type="submit" class="btn btn-outline-secondary w-100">
                                💾 Guardar como Borrador
                            </button>
                            <small class="text-muted">(Podrás continuar después)</small>
                        </form>
                    </div>
                </div>
            }

            @if (puedeCancelar)
            {
                <div class="card mt-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">❌ Cancelar Pedido</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-action="Cancelar">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />

                            <p class="mb-3">Esta acción marcará el pedido como cancelado, retirándolo del flujo de cocina.</p>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Motivo de Cancelación</label>
                                <textarea name="motivoCancelacion" class="form-control" placeholder="Motivo de cancelación (opcional)" rows="2"></textarea>
                            </div>

                            <p class="text-muted mb-3"><small>⚠️ Esta acción no se puede deshacer y registrará la cancelación en el historial.</small></p>

                            <button type="submit" class="btn btn-danger w-100">
                                ❌ Cancelar Pedido
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">🛒 Productos del Pedido</h5>
                    <div>
                        <span class="badge bg-primary me-2">@Model.Items.Count productos</span>
                        @if (editable)
                        {
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregarProducto">
                                <i class="lni lni-plus"></i> Agregar Producto
                            </button>
                        }
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.Items.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center" style="width: 150px;">Cantidad</th>
                                        <th class="text-end" style="width: 120px;">Precio Unit.</th>
                                        <th class="text-end" style="width: 120px;">Subtotal</th>
                                        @if (editable)
                                        {
                                            <th class="text-center" style="width: 80px;">Acciones</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Items)
                                    {
                                        <tr>
                                            <td>
                                                <div>
                                                    <strong>@item.NombreProducto</strong>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                @if (editable)
                                                {
                                                    <form method="post" asp-action="ActualizarCantidad" class="d-inline">
                                                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                                        <input type="hidden" name="itemId" value="@item.Id_Detalle" />
                                                        <div class="input-group input-group-sm" style="width: 120px;">
                                                            <input type="number" name="cantidad" value="@item.Cantidad"
                                                                   min="1" class="form-control text-center" />
                                                            <button type="submit" class="btn btn-outline-primary" title="Actualizar">
                                                                ✓
                                                            </button>
                                                        </div>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">@item.Cantidad</span>
                                                }
                                            </td>
                                            <td class="text-end">$@item.PrecioUnitario.ToString("N2")</td>
                                            <td class="text-end fw-bold">$@item.Subtotal.ToString("N2")</td>
                                            @if (editable)
                                            {
                                                <td class="text-center">
                                                    <form method="post" asp-action="EliminarProducto" class="d-inline">
                                                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />
                                                        <input type="hidden" name="itemId" value="@item.Id_Detalle" />
                                                        <button type="submit" class="btn btn-danger btn-sm" title="Eliminar producto">
                                                            🗑️
                                                        </button>
                                                    </form>
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-primary">
                                    <tr>
                                        <th colspan="3" class="text-end">Total del Pedido:</th>
                                        <th class="text-end">$@Model.Total.ToString("N2")</th>
                                        @if (editable)
                                        {
                                            <th></th>
                                        }
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center py-4">
                            <i class="lni lni-cart fs-1 text-muted"></i>
                            <p class="mb-1 fs-5">No hay productos en el pedido</p>
                            @if (editable)
                            {
                                <p class="mb-0"><small>Haz clic en "Agregar Producto" para comenzar</small></p>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary">
            ← Volver a la lista
        </a>
    </div>
</div>

@if (editable)
{
    <div class="modal fade" id="modalAgregarProducto" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">➕ Agregar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-action="AgregarProducto" id="formAgregarProducto">
                        <input type="hidden" name="pedidoId" value="@Model.Id_Venta" />

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Seleccionar Producto</label>
                                    <select name="productoId" class="form-select" required id="selectProducto">
                                        <option value="">-- Seleccione un producto --</option>
                                        @foreach (var producto in ViewBag.Productos as List<VentaFacil.web.Models.Dto.ProductoDto> ?? new List<VentaFacil.web.Models.Dto.ProductoDto>())
                                        {
                                            <option value="@producto.Id_Producto"
                                                    data-precio="@producto.Precio"
                                                    data-nombre="@producto.Nombre"
                                                    data-descripcion="@producto.Descripcion">
                                                @producto.Nombre - $@producto.Precio.ToString("N2")
                                            </option>
                                        }
                                    </select>
                                    <small class="text-muted">Seleccione un producto de la lista</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Cantidad</label>
                                    <input type="number" name="cantidad" class="form-control" value="1" min="1" max="100" required />
                                </div>
                            </div>
                        </div>

                        <div id="infoProducto" class="alert alert-info d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <strong id="nombreProducto"></strong>
                                    <p class="mb-0 small" id="descripcionProducto"></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="fw-bold text-primary" id="precioProducto"></span>
                                </div>
                            </div>
                        </div>

                        @if (!(ViewBag.Productos as List<VentaFacil.web.Models.Dto.ProductoDto> ?? new List<VentaFacil.web.Models.Dto.ProductoDto>()).Any())
                        {
                            <div class="alert alert-warning">
                                ⚠️ No hay productos disponibles en el catálogo.
                            </div>
                        }

                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="btnAgregar">
                                Agregar al Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Auto-submit para el select de modalidad
        document.querySelector('select[name="modalidad"]')?.addEventListener('change', function() {
            this.form.submit();
        });

        // Comportamiento del modal de productos
        document.addEventListener('DOMContentLoaded', function() {
            const selectProducto = document.getElementById('selectProducto');
            const infoProducto = document.getElementById('infoProducto');
            const nombreProducto = document.getElementById('nombreProducto');
            const descripcionProducto = document.getElementById('descripcionProducto');
            const precioProducto = document.getElementById('precioProducto');
            const btnAgregar = document.getElementById('btnAgregar');
            const formAgregarProducto = document.getElementById('formAgregarProducto');

            if (selectProducto) {
                selectProducto.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];

                    if (selectedOption.value) {
                        // Mostrar información del producto
                        nombreProducto.textContent = selectedOption.getAttribute('data-nombre');
                        descripcionProducto.textContent = selectedOption.getAttribute('data-descripcion') || 'Sin descripción';
                        precioProducto.textContent = '$' + parseFloat(selectedOption.getAttribute('data-precio')).toFixed(2);

                        infoProducto.classList.remove('d-none');
                        btnAgregar.disabled = false;
                    } else {
                        infoProducto.classList.add('d-none');
                        btnAgregar.disabled = true;
                    }
                });

                // Validar formulario antes de enviar
                formAgregarProducto.addEventListener('submit', function(e) {
                    if (!selectProducto.value) {
                        e.preventDefault();
                        alert('Por favor seleccione un producto');
                        selectProducto.focus();
                    }
                });
            }

            // Resetear modal cuando se cierre
            const modal = document.getElementById('modalAgregarProducto');
            if (modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    selectProducto.value = '';
                    infoProducto.classList.add('d-none');
                    btnAgregar.disabled = true;
                });
            }
        });
    </script>
}