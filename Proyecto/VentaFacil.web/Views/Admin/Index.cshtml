@using VentaFacil.web.Models.Response.Admin
@using VentaFacil.web.Models.Dto
@using VentaFacil.web.Models.Response.Producto
@model UsuarioListResponse
@{
    ViewData["Title"] = "Panel de administrador";
    Layout = "_LayoutPlantilla";
    var productosResponse = ViewData["Productos"] as ListProductoResponse ?? new ListProductoResponse();
}



<section class="table-components">
    <div class="pt-30">
        <div class="title-wrapper pt-30 mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="title">
                        <h2 class="fw-bold text-dark">Panel de Administrador</h2>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="breadcrumb-wrapper">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#0">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Gestión</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <div class="tables-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <div class="premium-card">
                        <ul class="nav nav-pills mb-4" id="adminTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active btn-premium" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">
                                    <i class="lni lni-users me-2"></i>Usuarios
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-premium" id="products-tab" data-bs-toggle="pill" data-bs-target="#products" type="button" role="tab" aria-controls="products" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Productos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link btn-premium" id="categoria-tab" data-bs-toggle="pill" data-bs-target="#categoria" type="button" role="tab" aria-controls="categoria" aria-selected="false">
                                    <i class="lni lni-package me-2"></i>Categoria
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="adminTabsContent">
                            <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                                <div class="table-container">
                                    <partial name="_GestionUsuarios" model="Model" />
                                </div>
                            </div>
                            <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                                <div class="table-container">
                                    <partial name="_GestionProductos" model="productosResponse" />
                                </div>
                            </div>
                            <div class="tab-pane fade" id="categoria" role="tabpanel" aria-labelledby="categoria-tab">
                                <div class="table-container text-center py-5">
                                    <i class="lni lni-package text-muted" style="font-size: 3rem;"></i>
                                    <h4 class="mt-3 text-muted">Gestión de Categorías</h4>
                                    <p class="text-muted">Esta funcionalidad estará disponible próximamente.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Funciones auxiliares globales para mensajes y errores
        function limpiarErrores() {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            const alert = document.querySelector('.alert-danger');
            if (alert) alert.remove();
        }

        function mostrarError(campoId, mensaje) {
            const input = document.getElementById(campoId);
            if (input) {
                input.classList.add('is-invalid');
                const errorSpan = document.querySelector(`span[data-valmsg-for="${campoId}"]`) || 
                                  document.querySelector(`span[data-valmsg-for="${campoId}"]`) ||
                                  input.nextElementSibling;
                if (errorSpan) errorSpan.textContent = mensaje;
            }
        }

        function mostrarErrorGeneral(mensaje) {
            const form = document.querySelector('.modal.show form');
            if (form) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="lni lni-warning me-2"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                form.insertBefore(alertDiv, form.firstChild);
            } else {
                alert(mensaje);
            }
        }

        function mostrarMensajeExito(mensaje) {
            const form = document.querySelector('.modal.show form');
            if (form) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="lni lni-checkmark-circle me-2"></i> ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                form.insertBefore(alertDiv, form.firstChild);
            }
        }

        function mostrarErroresEnFormulario(errors, fieldErrors) {
            if (errors && errors.length > 0) {
                mostrarErrorGeneral(errors.join('<br>'));
            }

            if (fieldErrors) {
                for (const [key, value] of Object.entries(fieldErrors)) {
                    // Intentar encontrar el campo por ID o nombre
                    const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        // Buscar el span de validación
                        let errorSpan = document.querySelector(`span[data-valmsg-for="${key}"]`);
                        if (!errorSpan) {
                          // Si no existe, buscar el siguiente elemento con clase text-danger
                          errorSpan = input.parentNode.querySelector('.text-danger');
                        }
                        
                        if (errorSpan) {
                            errorSpan.textContent = Array.isArray(value) ? value[0] : value;
                        }
                    }
                }
            }
        }

        // ==========================================
        // SOLUCIÓN GLOBAL PARA MODALES (Solución 2)
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Delegación de eventos para manejar cualquier modal dinámico
            document.body.addEventListener('keydown', function(e) {
                // Si el evento ocurre dentro de un modal
                if (e.target.closest('.modal')) {
                    // Si se presiona Enter en un input (no textarea, no submit)
                    if (e.key === 'Enter' && e.target.tagName === 'INPUT' && 
                        e.target.type !== 'submit' && e.target.type !== 'button') {
                        e.preventDefault();
                        console.log('Enter prevenido en modal globalmente');
                        return false;
                    }
                }
            });

            // Prevenir submit estándar en formularios de modales
            document.body.addEventListener('submit', function(e) {
                if (e.target.closest('.modal')) {
                    // Si el formulario no tiene data-ajax="true" (o similar), prevenimos
                    // En nuestro caso, manejamos todo con fetch manual, así que prevenimos SIEMPRE
                    // excepto si explícitamente queremos permitirlo (raro en este diseño)
                    // e.preventDefault(); 
                    // YA LO MANEJAMOS EN EL SCRIPT ESPECIFICO DE CADA MODAL, 
                    // PERO ESTO ES UNA CAPA EXTRA DE SEGURIDAD
                    console.log('Submit detectado en modal global');
                }
            });

            // Manejo de cierre de modales
            document.body.addEventListener('hide.bs.modal', function(e) {
                // Aquí podríamos agregar lógica para prevenir cierre si hay cambios
                // Por ahora solo logueamos
                console.log('Modal cerrándose:', e.target.id);
            });
        });
    </script>
}
