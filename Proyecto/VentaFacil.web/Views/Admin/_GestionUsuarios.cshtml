@model VentaFacil.web.Models.Response.Admin.UsuarioListResponse

<style>
    .premium-table thead th {
        background-color: #f8fafc;
        color: #fff !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        border-bottom: 2px solid #e2e8f0;
        padding: 1rem;
    }
    .main-btn.primary-btn.btn-hover {
        border-radius: 30px !important;
        padding-left: 2rem;
        padding-right: 2rem;
    }
    .input-group-search {
        border-radius: 30px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(109,76,65,0.08);
        background: #f8fafc;
    }
    .input-group-search input {
        border: none;
        background: #f8fafc;
        border-radius: 30px 0 0 30px;
        padding-left: 1.2rem;
        font-size: 1rem;
    }
    .input-group-search .btn-search {
        background: #6d4c41;
        color: #fff;
        border-radius: 0 30px 30px 0;
        border: none;
        font-weight: 600;
        padding: 0 1.5rem;
        transition: background 0.2s;
    }
    .input-group-search .btn-search:hover {
        background: #54362d;
        color: #fff;
    }
    .btn-clear {
        border-radius: 30px !important;
        background: #f3f4f6 !important;
        color: #6d4c41 !important;
        border: none;
        font-weight: 600;
        padding: 0.5rem 1.5rem;
        margin-left: 0.5rem;
        transition: background 0.2s;
    }
    .btn-clear:hover {
        background: #e0e0e0 !important;
        color: #54362d !important;
    }
</style>

<!-- Controles de Búsqueda y Filtros -->
<div class="row mb-4">
    <div class="col-md-8">
        <form method="get" asp-action="IndexUsuarios" class="row g-3" id="filtrosForm">
            <!-- Campo de búsqueda -->
            <div class="col-md-5">
                <div class="input-group input-group-search">
                    <input type="text" name="busqueda" class="form-control" 
                           placeholder="Buscar por nombre o correo..." 
                           value="@Model.Busqueda" />
                    <button type="submit" class="btn btn-search">
                        <i class="lni lni-search-alt"></i> Buscar
                    </button>
                </div>
            </div>

            <!-- Filtro por rol -->
            <div class="col-md-4">
                <select name="rolFiltro" class="form-select">
                    <option value="">Todos los roles</option>
                    @foreach (var rol in ViewBag.Roles)
                    {
                        <option value="@rol.Value" 
                                selected="@(Model.RolFiltro?.ToString() == rol.Value ? "selected" : null)">
                            @rol.Text
                        </option>
                    }
                </select>
            </div>

            <!-- Botones de acción -->
            <div class="col-md-3 d-flex align-items-center">
                <a href="@Url.Action("LimpiarFiltros", "Admin")" class="btn btn-clear">
                    <i class="lni lni-close"></i> Limpiar
                </a>
            </div>

            <!-- Campos ocultos para mantener otros parámetros -->
            <input type="hidden" name="pagina" value="1" />
            <input type="hidden" name="cantidadPorPagina" value="10" />
        </form>
    </div>

    <div class="col-md-4 text-end">
        <button type="button" class="main-btn primary-btn btn-hover" onclick="abrirModal('crear')">
            <i class="lni lni-plus"></i> Agregar Usuario
        </button>
    </div>
</div>

<!-- Mensaje cuando no hay resultados CON FILTROS APLICADOS -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No se encontraron usuarios</strong> que coincidan con los criterios de búsqueda.
        <a href="@Url.Action("LimpiarFiltros")" class="alert-link ms-2">Mostrar todos los usuarios</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Mensaje cuando no hay usuarios en absoluto -->
@if (Model.Usuarios != null && !Model.Usuarios.Any() && string.IsNullOrEmpty(Model.Busqueda) && !Model.RolFiltro.HasValue)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="lni lni-info-circle me-2"></i>
        <strong>No hay usuarios registrados en el sistema.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Tabla de Usuarios -->
<div class="table-wrapper table-responsive">
    <table class="table premium-table">
        <thead>
            <tr>
                <th class="lead-name"><h6>Nombre</h6></th>
                <th class="lead-email"><h6>Email</h6></th>
                <th class="lead-role"><h6>Rol</h6></th>
                <th><h6>Acción</h6></th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Usuarios != null && Model.Usuarios.Any())
            {
                foreach (var usuario in Model.Usuarios)
                {
                    <tr>
                        <td class="min-width">
                            <div class="lead">
                                <div class="lead-image">
                                    <img src="assets/images/lead/lead-1.png" alt="" />
                                </div>
                                <div class="lead-text">
                                    <p>@usuario.Nombre</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            <div class="lead">
                                <div class="lead-image">
                                    <img src="assets/images/lead/lead-1.png" alt="" />
                                </div>
                                <div class="lead-text">
                                    <p>@usuario.Correo</p>
                                </div>
                            </div>
                        </td>
                        <td class="min-width">
                            <span class="status-btn active-btn">@usuario.Rol</span>
                        </td>
                        <td>
                            <div class="action d-flex gap-2">
                                <!-- Ver -->
                                <a href="javascript:void(0);"
                                   onclick="abrirModal('ver', @usuario.Id_Usr)"
                                   class="text-primary" title="Ver">
                                    <i class="lni lni-eye"></i>
                                </a>

                                <!-- Editar -->
                                <a href="javascript:void(0);"
                                   onclick="abrirModal('editar', @usuario.Id_Usr)"
                                   class="text-warning" title="Editar">
                                    <i class="lni lni-pencil"></i>
                                </a>

                                <!-- Eliminar -->
                                <a class="text-danger" href="javascript:void(0);"
                                   onclick="confirmarEliminacion(@usuario.Id_Usr, '@usuario.Nombre.Replace("'", "\\'")')"
                                   title="Eliminar">
                                    <i class="lni lni-trash-can"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            }
            else if (Model.Usuarios != null && !Model.Usuarios.Any())
            {
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="text-muted">
                            <i class="lni lni-users me-2"></i>
                            @if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                            {
                                <span>No se encontraron usuarios con los filtros aplicados</span>
                            }
                            else
                            {
                                <span>No hay usuarios registrados</span>
                            }
                        </div>
                    </td>
                </tr>
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="text-muted">
                            <i class="lni lni-warning me-2"></i>
                            Error al cargar los usuarios
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="modalContainer"></div>

<!-- Menú de Paginación -->
@if (Model.TotalPaginas > 1 && Model.Usuarios != null && Model.Usuarios.Any())
{
    <div class="pagination-wrapper mt-4">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <!-- Botón Anterior -->
                <li class="page-item @(Model.PaginaActual == 1 ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual - 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })"
                       tabindex="-1" aria-disabled="@(Model.PaginaActual == 1 ? "true" : "false")">
                        <i class="lni lni-chevron-left"></i>
                    </a>
                </li>

                <!-- Números de página -->
                @for (int i = 1; i <= Model.TotalPaginas; i++)
                {
                    <li class="page-item @(i == Model.PaginaActual ? "active" : "")">
                        <a class="page-link" 
                           href="@Url.Action("IndexUsuarios", "Admin", new { 
                               pagina = i, 
                               cantidadPorPagina = 10,
                               busqueda = Model.Busqueda,
                               rolFiltro = Model.RolFiltro
                           })">@i</a>
                    </li>
                }

                <!-- Botón Siguiente -->
                <li class="page-item @(Model.PaginaActual == Model.TotalPaginas ? "disabled" : "")">
                    <a class="page-link" 
                       href="@Url.Action("IndexUsuarios", "Admin", new { 
                           pagina = Model.PaginaActual + 1, 
                           cantidadPorPagina = 10,
                           busqueda = Model.Busqueda,
                           rolFiltro = Model.RolFiltro
                       })">
                        <i class="lni lni-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Información de paginación -->
        <div class="pagination-info text-center mt-2">
            @{
                var inicio = (Model.PaginaActual - 1) * 10 + 1;
                var fin = Math.Min(Model.PaginaActual * 10, Model.TotalUsuarios);
            }
            
            <p class="text-sm text-muted">
                Mostrando @inicio-@fin de @Model.TotalUsuarios registros
                
                @if (!string.IsNullOrEmpty(Model.Busqueda) || Model.RolFiltro.HasValue)
                {
                    <span class="ms-2">
                        <a href="@Url.Action("LimpiarFiltros")" class="text-primary text-decoration-underline">
                            (Ver todos)
                        </a>
                    </span>
                }
            </p>
        </div>
    </div>
}

<script>
    // ========== FUNCIONALIDAD PARA USUARIOS ==========
    
    // Auto-submit del filtro de rol cuando cambia
    const rolFilter = document.getElementById('rolFiltroSelect'); // We will add this ID
    if (rolFilter) {
        rolFilter.addEventListener('change', function() {
            console.log('Filtro de rol cambiado, enviando formulario...');
            document.getElementById('filtrosForm').submit();
        });
    } else {
        // Fallback for current selector if ID not added yet (or add ID in separate edit)
        document.querySelector('#filtrosForm select[name="rolFiltro"]')?.addEventListener('change', function() {
            console.log('Filtro de rol cambiado (selector genérico), enviando formulario...');
            document.getElementById('filtrosForm').submit();
        });
    }

    // Manejar el evento de enter en el campo de búsqueda
    const busquedaInput = document.querySelector('#filtrosForm input[name="busqueda"]');
    if (busquedaInput) {
        busquedaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log('Enter en búsqueda, enviando formulario...');
                document.getElementById('filtrosForm').submit();
            }
        });
        
        // Prevent search input from triggering other things on input
         busquedaInput.addEventListener('input', function(e) {
            e.stopPropagation();
        });
    }

    // Función para abrir el modal
    let rolInicial = '';

    function abrirModal(accion, usuarioId = null) {
        console.log('Abriendo modal:', accion, 'Usuario ID:', usuarioId);

        let url = '';
        const params = new URLSearchParams();

        // Agregar parámetros básicos
        params.append('accion', accion);

        if (usuarioId) {
            params.append('usuarioId', usuarioId);
        }

        // Mantener filtros
        const busqueda = '@Html.Raw(Model.Busqueda ?? "")';
        const rolFiltro = '@(Model.RolFiltro?.ToString() ?? "")';
        const pagina = '@Model.PaginaActual';

        if (busqueda) params.append('busqueda', busqueda);
        if (rolFiltro) params.append('rolFiltro', rolFiltro);
        if (pagina) params.append('pagina', pagina);

        url = '@Url.Action("ObtenerModalUsuario", "Admin")' + '?' + params.toString();
        console.log('URL del modal:', url);

        // Cargar modal via AJAX
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Error al cargar el modal: ' + response.status);
                return response.text();
            })
            .then(data => {
                document.getElementById('modalContainer').innerHTML = data;
                const modalElement = document.getElementById('usuarioModal');
        
                if (!modalElement) {
                    console.error('Modal element no encontrado después de cargar');
                    return;
                }
        
                // Destruir instancia previa si existe para evitar conflictos
                const prevModal = bootstrap.Modal.getInstance(modalElement);
                if (prevModal) {
                    prevModal.dispose();
                }

                // Inicializar con opciones robustas
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
        
                // Configurar el evento cuando el modal se muestra completamente
                modalElement.addEventListener('shown.bs.modal', function () {
                    console.log('Modal mostrado, configurando submit para:', accion);
                    
                    // Capturar el rol inicial si es edición
                    if (accion === 'editar') {
                        const rolSelect = document.getElementById('Rol');
                        rolInicial = rolSelect ? rolSelect.value : '';
                        console.log('Rol inicial capturado:', rolInicial);
                    }
                    
                    configurarSubmitForm(accion);
                });
        
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar el formulario: ' + error.message);
            });
    }
    
    function configurarSubmitForm(accion) {
        const form = document.getElementById('usuarioForm');

        if (!form) {
            console.error('Formulario no encontrado en configurarSubmitForm');
            return;
        }

        console.log('Configurando submit para acción:', accion, 'Form:', form);

        // Remover event listeners previos para evitar duplicados
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);

        newForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log('Submit del formulario para acción:', accion);

            // Limpiar errores previos
            limpiarErrores();

            // Validación manual del frontend
            let isValid = true;

            const contrasena = document.getElementById('Contrasena')?.value || '';
            const confirmar = document.getElementById('ConfirmarContrasena')?.value || '';
            const rolActual = document.getElementById('Rol')?.value || '';

            // Confirmación de cambio de rol
            if (accion === 'editar' && rolInicial !== '' && rolActual !== rolInicial) {
                if (!confirm('¿Está seguro que desea cambiar el rol de este usuario?')) {
                    console.log('Cambio de rol cancelado por el usuario');
                    return false;
                }
            }

            if (accion === 'crear') {
                if (!contrasena || contrasena.length < 6) {
                    mostrarError('Contrasena', 'La contraseña es requerida y debe tener al menos 6 caracteres');
                    isValid = false;
                } else if (contrasena !== confirmar) {
                    mostrarError('ConfirmarContrasena', 'Las contraseñas no coinciden');
                    isValid = false;
                }
            }

            if (accion === 'editar') {
                if (contrasena || confirmar) {
                    if (!contrasena || !confirmar) {
                        mostrarError('Contrasena', 'Debe completar ambos campos de contraseña si desea cambiarla');
                        isValid = false;
                    } else if (contrasena.length < 6) {
                        mostrarError('Contrasena', 'La contraseña debe tener al menos 6 caracteres');
                        isValid = false;
                    } else if (contrasena !== confirmar) {
                        mostrarError('ConfirmarContrasena', 'Las contraseñas no coinciden');
                        isValid = false;
                    }
                }
            }

            if (!isValid) {
                console.log('Validación frontend fallida');
                return false;
            }

            // Crear FormData directamente desde el formulario
            const formData = new FormData(newForm);

            // Debug: mostrar datos que se enviarán
            console.log('Datos a enviar:');
            for (let [key, value] of formData.entries()) {
                console.log(key + ': ' + value);
            }

            // Enviar la solicitud
            const url = '@Url.Action("GuardarUsuario", "Admin")';
            console.log('Enviando a:', url);

            fetch(url, {
                method: 'POST',
                body: formData // FormData establece automáticamente los headers correctos
            })
            .then(response => {
                console.log('Respuesta HTTP - Status:', response.status, 'OK:', response.ok);

                return response.text().then(text => {
                    console.log('Respuesta completa recibida:', text);

                    try {
                        // Intentar parsear como JSON
                        const jsonData = JSON.parse(text);
                        console.log('Parseado como JSON exitosamente:', jsonData);
                        return jsonData;
                    } catch (e) {
                        console.log('No es JSON válido, manejando como texto/HTML');
                    
                        if (response.status === 400) {
                            return {
                                success: false,
                                message: 'Error de validación en el servidor',
                                errors: ['Por favor verifique que todos los campos sean correctos'],
                                fieldErrors: {}
                            };
                        }
                    
                        if (!response.ok) {
                            return {
                                success: false,
                                message: `Error del servidor: ${response.status}`,
                                errors: [text.substring(0, 200)],
                                fieldErrors: {}
                            };
                        }
                    
                        return {
                            success: false,
                            message: 'Respuesta inesperada del servidor',
                            errors: [text],
                            fieldErrors: {}
                        };
                    }
                });
            })
            .then(result => {
                if (!result) return;

                console.log('Resultado procesado:', result);

                if (result.success) {
                    mostrarMensajeExito(result.message);
            
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('usuarioModal'));
                        if (modal) modal.hide();
                        window.location.reload();
                    }, 1500);
                } else {
                    console.log('Mostrando errores:', result.errors, result.fieldErrors);
                    if (result.errors || result.fieldErrors) {
                        mostrarErroresEnFormulario(result.errors || [], result.fieldErrors || null);
                    } else {
                        mostrarErrorGeneral(result.message || 'Error desconocido');
                    }
                }
            })
            .catch(err => {
                console.error('Error en fetch:', err);
                mostrarErrorGeneral('Error de conexión: ' + err.message);
            });
        });
    }

    function confirmarEliminacion(usuarioId, nombreUsuario) {
        if (confirm(`¿Está seguro que desea eliminar al usuario "${nombreUsuario}"?`)) {
            fetch(`@Url.Action("EliminarUsuario", "Admin")?id=${usuarioId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    mostrarMensajeExito('Usuario eliminado correctamente');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    mostrarErrorGeneral('Error al eliminar el usuario');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarErrorGeneral('Error de conexión');
            });
        }
    }
</script>
